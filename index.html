<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gpack X - V60</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; font-size: 12px; color: #1e293b; }
        .lang-select { padding: 2px 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px; background: white; color: #64748b; cursor: pointer; outline: none; }
        .card { background: white; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 10px 14px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-weight: 700; color: #334155; font-size: 12px; }
        select, input { font-size: 12px; }
        .input-std { width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 5px 8px; background: white; height: 30px; transition: all 0.2s; }
        .input-std:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 1px rgba(59,130,246,0.1); }
        .limit-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
        .limit-row label { font-size: 10px; font-weight: 600; color: #64748b; }
        .limit-row input { width: 60px; text-align: right; }
        .plan-card { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 15px; break-inside-avoid; overflow: hidden; }
        
        .tab-btn { transition: all 0.2s; padding: 12px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; border-bottom: 3px solid transparent; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; background-color: #ffffff; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #64748b; background-color: #f1f5f9; }
        .tab-inactive:hover { background: #e2e8f0; color: #334155; }
        
        .badge-count { font-size: 11px; padding: 2px 6px; border-radius: 99px; font-weight: bold; }
        .compact-label { font-size: 9px; font-weight: 700; color: #64748b; display: block; margin-bottom: 2px; text-transform: uppercase; }

        #fixedCalcButtonArea {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #ffffff; border-top: 1px solid #e2e8f0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); padding: 8px 0; z-index: 999;
        }
        
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; z-index: 10000; display: flex; flex-col;
            align-items: center; justify-content: center;
        }
        .login-box {
            background: white; padding: 2rem; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            width: 100%; max-width: 350px; text-align: center;
        }
        
        /* İmza Stili */
        .coded-by {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-family: 'Roboto Mono', monospace;
            font-size: 10px;
            color: #94a3b8; /* slate-400 */
            opacity: 0.5;
            z-index: 10001;
            pointer-events: none;
            font-weight: 500;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
        }

        /* Editable Input Style */
        .editable-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 2px 4px;
            border-radius: 3px;
            text-align: right;
            width: 60px; 
            box-sizing: border-box;
            transition: all 0.1s;
        }
        .editable-input:focus {
            background: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 1px rgba(59,130,246,0.1);
        }
        .editable-input-sm {
            width: 55px;
            padding: 1px 3px;
            font-size: 10px;
        }
        .editable-input-lg {
            width: 70px;
        }
        
        /* V2.11 Logo Stili (Mühendis Koyun teması) */
        .logo-box {
            background: #fefcf5; 
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            color: #64748b; 
        }
        .logo-icon {
            color: #d1d5db; 
            font-size: 20px;
        }


        @media print {
            .no-print { display: none !important; }
            #mainAppContent { display: block !important; }
            body { padding: 0; background: white; }
            .plan-card { border: 2px solid #000; box-shadow: none; }
            #fixedCalcButtonArea { display: none !important; }
            .coded-by { display: none; }
        }
    </style>
</head>
<body class="pb-20 text-slate-800">

    <div class="coded-by">Coded by Emrah Sengul</div>

    <div id="loginOverlay">
        <div class="login-box">
            <div class="mb-6">
                <div class="logo-box w-12 h-12 rounded-full mx-auto flex items-center justify-center shadow mb-3 text-xl relative">
                    <i class="fas fa-drafting-compass logo-icon absolute"></i>
                    <i class="fas fa-hard-hat text-yellow-500 text-3xl absolute top-[-5px] left-[50%] transform -translate-x-1/2 -rotate-12 opacity-80"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 leading-tight" data-key="app_title">Gpack X</h1>
                <p class="text-xs text-slate-500 font-bold tracking-wider mt-1" data-key="app_desc">GRP Pipe & Fitting Packing Optimiser</p>
            </div>
            <div class="space-y-3 text-left">
                <div>
                    <label class="compact-label" data-key="lbl_username">KULLANICI ADI</label>
                    <input type="text" id="loginUser" class="input-std h-9" placeholder="...">
                </div>
                <div>
                    <label class="compact-label" data-key="lbl_password">ŞİFRE</label>
                    <input type="password" id="loginPass" class="input-std h-9" placeholder="...">
                </div>
                <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-xs transition mt-2" data-key="btn_login">GİRİŞ YAP</button>
            </div>
            <div class="mt-6 border-t border-slate-100 pt-4">
                <select onchange="changeLanguage(this.value)" class="lang-select px-2 py-1">
                    <option value="tr">Türkçe</option>
                    <option value="en">English</option>
                </select>
            </div>
        </div>
    </div>

    <div id="mainAppContent" class="hidden">
        <div class="container mx-auto max-w-7xl p-2 md:p-4 mb-20"> 
            <div class="no-print mb-4 bg-white p-3 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-3">
                <div class="flex items-center gap-2">
                    <div class="bg-slate-800 text-white w-8 h-8 rounded flex items-center justify-center shadow"><i class="fas fa-cubes"></i></div>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 leading-tight" data-key="app_title">Gpack X</h1>
                        <p class="text-[10px] text-slate-500 font-bold" data-key="app_desc">GRP Pipe & Fitting Packing Optimiser</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <select id="langSelectMain" onchange="changeLanguage(this.value)" class="lang-select">
                        <option value="tr">TR</option>
                        <option value="en">EN</option>
                    </select>
                    <button onclick="downloadReport('pdf')" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-[10px] font-bold border border-red-700"><i class="fas fa-file-pdf mr-1"></i> <span data-key="btn_pdf">PDF İNDİR</span></button>
                    <button onclick="downloadReport('word')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-[10px] font-bold"><i class="fas fa-file-word mr-1"></i> <span data-key="btn_word">WORD</span></button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 no-print">
                <div class="lg:col-span-3 space-y-3">
                    <div class="card sticky top-4">
                        <div class="card-header"><span data-key="sec_settings">SEVKİYAT AYARLARI</span> <i class="fas fa-truck text-slate-400"></i></div>
                        <div class="p-3 space-y-3">
                            <div><label class="compact-label" data-key="lbl_user">KULLANICI ADI</label><input id="txtUser" type="text" class="input-std font-bold text-blue-700 bg-blue-50/50" value="" readonly></div>
                            <div><label class="compact-label" data-key="lbl_project">PROJE REFERANSI</label><input id="txtProject" type="text" class="input-std" placeholder="..."></div>
                            <div><label class="compact-label" data-key="lbl_vehicle">ARAÇ TİPİ</label><select id="transportType" onchange="loadTransportLimits()" class="input-std font-semibold text-blue-900"></select></div>
                            
                            <div>
                                <label class="compact-label" data-key="lbl_nest_gap">NESTING GÜVENLİK (mm)</label>
                                <select id="nestingGap" class="input-std font-semibold text-slate-900">
                                    <option value="50" data-key="opt_safe_50" selected>50 mm (Standart)</option>
                                    <option value="35" data-key="opt_safe_35">35 mm (Riskli)</option>
                                </select>
                            </div>

                            <div class="flex items-center h-[30px] px-3 bg-white border border-slate-200 rounded">
                                <label class="flex items-center gap-1.5 cursor-pointer">
                                    <input type="checkbox" id="alternatingLoad" class="w-3.5 h-3.5 accent-blue-600">
                                    <span class="text-[11px] font-bold text-slate-700" data-key="opt_alt_load">Şaşırtmalı Yükleme (Risk Azaltma)</span>
                                </label>
                            </div>

                            <div>
                                <button onclick="toggleElement('palletSettings', 'palletIcon')" class="w-full py-1.5 px-2 bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-600 rounded text-[10px] font-bold flex items-center justify-between transition">
                                    <span data-key="lbl_pallet_dims">PALET ÖLÇÜLERİ (mm)</span><i id="palletIcon" class="fas fa-chevron-down"></i>
                                </button>
                                <div id="palletSettings" class="hidden mt-2 bg-slate-50 p-2 rounded border border-slate-200">
                                    <div class="limit-row"><label data-key="lim_w">EN (mm)</label><input type="number" id="palletW" class="input-std h-6 text-[10px]" value="1200"></div>
                                    <div class="limit-row"><label data-key="lim_l">BOY (mm)</label><input type="number" id="palletL" class="input-std h-6 text-[10px]" value="800"></div>
                                    <div class="limit-row"><label data-key="lim_h">YÜK (mm)</label><input type="number" id="palletH" class="input-std h-6 text-[10px]" value="145"></div>
                                </div>
                            </div>

                            <div>
                                <button onclick="toggleElement('limitSettings', 'limitIcon')" class="w-full py-1.5 px-2 bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-600 rounded text-[10px] font-bold flex items-center justify-between transition">
                                    <span data-key="lbl_limits">ARAÇ LİMİTLERİ</span><i id="limitIcon" class="fas fa-chevron-down"></i>
                                </button>
                                <div id="limitSettings" class="hidden mt-2 bg-slate-50 p-2 rounded border border-slate-200">
                                    <div class="limit-row"><label data-key="lim_l">BOY (mm)</label><input type="number" id="maxL" class="input-std h-6 text-[10px]"></div>
                                    <div class="limit-row"><label data-key="lim_w">EN (mm)</label><input type="number" id="maxW" class="input-std h-6 text-[10px]"></div>
                                    <div class="limit-row"><label data-key="lim_h">YÜK (mm)</label><input type="number" id="maxH" class="input-std h-6 text-[10px]"></div>
                                    <div class="limit-row"><label data-key="lim_kg" id="lblMaxKg">KAPASİTE (Ton)</label><input type="number" id="maxWeight" class="input-std h-6 text-[10px] font-bold text-blue-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-9 flex flex-col">
                    <div class="card flex-1 flex flex-col min-h-[500px]">
                        <div class="flex border-b border-slate-200 bg-white">
                            <button onclick="switchTab('pipe')" id="tabPipe" class="tab-btn tab-active flex-1 flex items-center justify-center gap-2">
                                <i class="fas fa-circle-notch"></i> <span data-key="tab_list_pipe">BORU EKLE</span> <span id="cntPipeBadge" class="bg-blue-100 text-blue-800 badge-count ml-1">0</span>
                            </button>
                            <button onclick="switchTab('fit')" id="tabFit" class="tab-btn tab-inactive flex-1 flex items-center justify-center gap-2">
                                <i class="fas fa-shapes"></i> <span data-key="tab_list_fit">FITTING EKLE</span> <span id="cntFitBadge" class="bg-teal-100 text-teal-800 badge-count ml-1">0</span>
                            </button>
                        </div>

                        <div id="pipeContent" class="flex-1 flex flex-col">
                            <div class="p-3 bg-blue-50/50 border-b border-blue-100 shadow-sm z-10">
                                <div class="flex flex-wrap gap-2 items-end">
                                    <div class="w-24"><label class="compact-label text-blue-800" data-key="lbl_dn">DN</label><select id="pipeDN" class="input-std font-bold text-blue-900"></select></div>
                                    <div class="w-20"><label class="compact-label text-blue-800" data-key="lbl_pn">PN</label><select id="pipePN" class="input-std"><option value="1">PN1</option><option value="6">PN6</option><option value="10" selected>PN10</option><option value="16">PN16</option><option value="20">PN20</option><option value="25">PN25</option><option value="32">PN32</option></select></div>
                                    <div class="w-24"><label class="compact-label text-blue-800" data-key="lbl_sn">SN</label><select id="pipeSN" class="input-std"><option value="5000">SN5000</option><option value="10000" selected>SN10000</option><option value="15000">SN15000</option><option value="20000">SN20000</option><option value="25000">SN25000</option></select></div>
                                    <div class="w-20"><label class="compact-label text-blue-800" data-key="lbl_len">Boy(m)</label><input type="number" id="pipeLen" value="12" class="input-std text-center"></div>
                                    <div class="w-24"><label class="compact-label text-blue-800" data-key="lbl_total">Toplam(m)</label><input type="number" id="pipeTotal" value="120" class="input-std font-bold text-blue-700 text-center"></div>
                                    <div class="flex items-center h-[30px] px-3 bg-white border border-blue-200 rounded"><label class="flex items-center gap-1.5 cursor-pointer"><input type="checkbox" id="pipeCpl" class="w-3.5 h-3.5 accent-blue-600" checked><span class="text-[11px] font-bold text-blue-700" data-key="opt_cpl">Manşonlu</span></label></div>
                                    <button onclick="addPipeToList()" class="ml-auto px-5 h-[30px] bg-blue-600 hover:bg-blue-700 text-white font-bold rounded text-xs shadow-sm flex items-center gap-1 transition">
                                        <i class="fas fa-plus"></i> <span data-key="btn_add_pipe">EKLE</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto bg-white relative">
                                <div class="absolute inset-0 overflow-auto">
                                    <table class="w-full text-left text-xs border-collapse">
                                        <thead class="bg-blue-50 text-slate-600 border-b border-blue-100 sticky top-0 z-10"><tr><th class="p-2 pl-3 font-semibold" data-key="th_desc">Tanım</th><th class="p-2 text-center font-semibold" data-key="th_len">Boy(m)</th><th class="p-2 text-right font-semibold" data-key="th_total">Miktar(m)</th><th class="p-2 text-center" data-key="lbl_weight">Birim Kg</th><th class="p-2 w-8"></th></tr></thead>
                                        <tbody id="tbodyPipe" class="divide-y divide-blue-50 bg-white"></tbody>
                                    </table>
                                    <div id="pipeEmptyState" class="p-10 text-center text-blue-400 flex flex-col items-center justify-center h-full"><i class="fas fa-arrow-up text-3xl mb-3 opacity-50"></i><span class="text-xs font-semibold">Liste boş. Yukarıdan boru ekleyin.</span></div>
                                </div>
                            </div>
                             <div class="p-2 bg-blue-50 border-t border-blue-100 flex justify-between items-center px-3"><span class="text-[10px] text-blue-500 font-bold"><span id="cntPipe">0</span> kayıt</span><button onclick="clearPipes()" class="text-[10px] text-red-500 hover:text-red-700 font-bold px-2 py-1">Temizle</button></div>
                        </div>

                        <div id="fitContent" class="flex-1 flex flex-col hidden">
                            <div class="p-3 bg-teal-50/50 border-b border-teal-100 shadow-sm z-10">
                                <div class="flex gap-4">
                                    <div class="hidden md:flex flex-col items-center justify-center bg-white border border-teal-200 rounded-lg w-24 h-24 shadow-sm p-2 shrink-0">
                                        <div id="fitPreviewImg" class="w-full h-full flex items-center justify-center text-teal-600 opacity-80"></div>
                                        <span class="text-[9px] font-bold text-teal-800 mt-1 uppercase" id="fitPreviewLabel">BEND</span>
                                    </div>

                                    <div class="flex-1">
                                        <div class="flex flex-wrap gap-2 items-end mb-2 border-b border-teal-100 pb-2">
                                            <div class="flex-1 min-w-[120px]">
                                                <label class="compact-label text-teal-800" data-key="lbl_type">Tip</label>
                                                <select id="fitType" onchange="renderFitDynamic()" class="input-std font-bold text-teal-800 py-0"></select>
                                            </div>
                                            <div class="w-20">
                                                <label class="compact-label text-teal-800" data-key="lbl_pn">PN</label>
                                                <select id="fitPN" class="input-std py-0" onchange="fillDim()"><option value="1">PN1</option><option value="6">PN6</option><option value="10" selected>PN10</option><option value="16">PN16</option><option value="20">PN20</option><option value="25">PN25</option><option value="32">PN32</option></select>
                                            </div>
                                            <div class="w-20" id="divFitSN">
                                                <label class="compact-label text-teal-800" data-key="lbl_sn">SN</label>
                                                <select id="fitSN" class="input-std py-0"><option value="5000">5000</option><option value="10000" selected>10000</option><option value="15000">SN15000</option><option value="20000">SN20000</option><option value="25000">SN25000</option></select>
                                            </div>
                                            <div class="w-16">
                                                <label class="compact-label text-teal-800" data-key="lbl_qty">Adet</label>
                                                <input type="number" id="fitQty" value="1" class="input-std font-bold text-center py-0">
                                            </div>
                                            <div class="w-24">
                                                <label class="compact-label text-teal-800" data-key="lbl_pack">Paketleme</label>
                                                <select id="fitPackSelect" class="input-std py-0 font-bold text-teal-700"><option value="Pallet" data-key="opt_pallet" selected>Paletli</option><option value="Loose" data-key="opt_loose">Dökme</option></select>
                                            </div>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-2 items-end">
                                            <div id="fitDynamic" class="flex flex-wrap gap-2 items-end"></div>
                                            <div id="fitOptions" class="flex flex-wrap gap-2 items-end"></div> 
                                            <button onclick="addFitToList()" class="ml-auto px-5 h-[30px] bg-teal-600 hover:bg-teal-700 text-white font-bold rounded text-xs shadow-sm flex items-center gap-1 transition">
                                                <i class="fas fa-plus"></i> <span data-key="btn_add_fit">EKLE</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto bg-white relative">
                                <div class="absolute inset-0 overflow-auto">
                                    <table class="w-full text-left text-xs border-collapse">
                                        <thead class="bg-teal-50 text-slate-600 border-b border-teal-100 sticky top-0 z-10"><tr><th class="p-2 pl-3 font-semibold" data-key="th_desc">Tanım</th><th class="p-2 font-semibold" data-key="th_det">Detay</th><th class="p-2 text-center font-semibold" data-key="th_pack">Paket</th><th class="p-2 text-center font-semibold" data-key="th_dim">Ölçü (mm)</th><th class="p-2 text-center font-semibold" data-key="th_qty">Adet</th><th class="p-2 text-center font-semibold">Kg</th><th class="p-2 w-8"></th></tr></thead>
                                        <tbody id="tbodyFit" class="divide-y divide-teal-50 bg-white"></tbody>
                                    </table>
                                    <div id="fitEmptyState" class="p-10 text-center text-teal-400 flex flex-col items-center justify-center h-full"><i class="fas fa-arrow-up text-3xl mb-3 opacity-50"></i><span class="text-xs font-semibold">Liste boş. Yukarıdan fitting ekleyin.</span></div>
                                </div>
                            </div>
                            <div class="p-2 bg-teal-50 border-t border-teal-100 flex justify-between items-center px-3"><span class="text-[10px] text-teal-500 font-bold"><span id="cntFit">0</span> kayıt</span><button onclick="clearFits()" class="text-[10px] text-red-500 hover:text-red-700 font-bold px-2 py-1">Temizle</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="resultArea" class="hidden mt-6">
                
                <button onclick="toggleElement('assumptionsContent', 'assumptionsIcon')" class="w-full py-1.5 px-2 bg-slate-100 border border-slate-200 hover:bg-slate-200 text-slate-600 rounded text-[10px] font-bold flex items-center justify-between transition mb-3">
                    <span data-key="lbl_assumptions">HESAPLAMA VARSAYIMLARI</span><i id="assumptionsIcon" class="fas fa-chevron-down"></i>
                </button>
                <div id="assumptionsContent" class="hidden mb-4 p-3 bg-slate-100 border border-slate-200 rounded text-slate-500 text-[10px] leading-relaxed">
                    <ul class="list-disc pl-4 space-y-0.5">
                        <li data-key="note_1">Boru ve fittingler için standart katalog ölçüleri esas alınmıştır.</li>
                        <li data-key="note_2">Fitting ağırlık hesaplamalarına laminasyon ağırlıkları dahil edilmemiştir.</li>
                        <li data-key="note_3">Araç başı ağırlık ve taban alanı kullanımı verileri; yüklenen ürünlerin, araç kapasitesine (hacim ve alan) olan doluluk oranını ifade etmektedir.</li>
                        <li data-key="note_4">Boru ve fitting ağırlıkları standart olarak hesaplanmıştır ve üreticiye göre farklılık gösterebilir.</li>
                        <li data-key="note_5">Paletli ürünler için 1.1x1.1m taban alanı ve %15 hacim artışı öngörülmüştür. Dökme parçalar için 0.90 pratik hacim faktörü uygulanmıştır.</li>
                        <li id="note_6">Boru iç içe yerleşiminde (Nesting) 50mm (Standart) güvenlik mesafesi kullanılmıştır.</li>
                        <li id="note_7">Manşonlu borular için tam manşon boyu ek uzunluk kullanılmıştır (Şaşırtmalı Yükleme).</li>
                    </ul>
                </div>
                <div class="flex items-center gap-2 mb-3"><div class="h-px flex-1 bg-slate-300"></div><span class="text-xs font-bold text-slate-500 uppercase tracking-wider" data-key="res_title">Yükleme Planı Sonuçları</span><div class="h-px flex-1 bg-slate-300"></div></div>
                <div id="planContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 print:block"></div>
            </div>
            
            </div>
        
        <div id="fixedCalcButtonArea" class="no-print">
            <div class="container mx-auto max-w-7xl p-2 md:p-4">
                <button onclick="calculateAll()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-2.5 rounded shadow flex items-center justify-center gap-2 text-xs transition active:scale-[0.98]">
                    <i class="fas fa-calculator text-yellow-400"></i> <span data-key="btn_calc">HESAPLA & PLAN OLUŞTUR</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('contextmenu', event => event.preventDefault());
        
        // --- TRANSLATIONS (KISALTILMIŞ) ---
        const TRANSLATIONS={
            tr:{
                app_title:"Gpack X",app_desc:"GRP Pipe & Fitting Packing Optimiser",btn_pdf:"PDF İNDİR",btn_word:"WORD İNDİR",
                sec_settings:"SEVKİYAT AYARLARI",lbl_user:"KULLANICI",lbl_project:"PROJE REFERANSI",lbl_vehicle:"ARAÇ TİPİ",lbl_limits:"ARAÇ LİMİTLERİ",
                lim_l:"BOY (m)",lim_w:"EN (m)",lim_h:"YÜKSEKLİK (m)",lim_kg:"KAPASİTE (Ton)",
                tab_list_pipe:"BORU EKLE",tab_list_fit:"FITTING EKLE",
                lbl_dn:"ÇAP (DN)",lbl_pn:"PN",lbl_sn:"SN",opt_cpl:"Manşonlu",opt_plain:"Düz Uç",lbl_len:"BORU BOYU (m)",lbl_total:"TOPLAM (m)",btn_add_pipe:"EKLE",
                fit_plan_title:"YÜKLEME DETAYI",lbl_type:"PARÇA TİPİ",lbl_pack:"PAKETLEME",opt_loose:"Dökme",opt_pallet:"Paletli",lbl_qty:"ADET",btn_add_fit:"EKLE",
                sec_list:"ÜRETİM LİSTESİ",btn_clear:"SİL",
                th_desc:"Tanım",th_len:"Boy",th_total:"Miktar",th_det:"Detail",th_pack:"Pack",th_dim:"Ölçü",th_qty:"Adet",
                btn_calc:"HESAPLA & PLAN OLUŞTUR",res_title:"Yükleme Planı Sonuçları",
                sec_res_pipe:"BÖLÜM 1: BORU SEVKİYATI",sec_res_fit:"BÖLÜM 2: FITTING SEVKİYATI",
                type_tee:"TEE",type_bend:"Dirsek",type_red:"Redüksiyon",type_flg:"Flanş",type_cpl:"Manşon",type_custom:"Özel Parça", 
                opt_empty:"Yok",
                dim_main:"ÇAP", dim_in:"Giriş", dim_out:"Çıkış", dim_br:"Branş", dim_len:"Boy", dim_h:"Branş Uz.", dim_ang:"Açı", dim_arm:"Kol",
                lbl_opt_in:"Giriş Opsiyonu", lbl_opt_out:"Çıkış Opsiyonu", lbl_opt_br:"Branş Opsiyonu",
                truck:"ARAÇ",tr_std:"Standart Tır (13.60m)",tr_40hc:"40\" HC",tr_40ot:"40\" OT",tr_20dc:"20\" DC",tr_low:"Lowbed Tır",
                err_limits_exceeded: "UYARI: Limit aşımı.", lbl_weight: "Birim Kg",
                lbl_username:"KULLANICI ADI", lbl_password:"ŞİFRE", btn_login:"GİRİŞ YAP", app_ver:"V2.11 | GRP Pipe & Fitting Packing Optimiser",
                lbl_assumptions: "HESAPLAMA VARSAYIMLARI:",
                note_1: "Boru ve fittingler için standart katalog ölçüleri esas alınmıştır.",
                note_2: "Fitting ağırlık hesaplamalarına laminasyon ağırlıkları dahil edilmemiştir.",
                note_3: "Araç başı ağırlık ve taban alanı kullanımı verileri; yüklenen ürünlerin, araç kapasitesine (hacim ve alan) olan doluluk oranını ifade etmektedir.",
                note_4: "Boru ve fitting ağırlıkları standart olarak hesaplanmıştır ve üreticiye göre farklılık gösterebilir.",
                note_5: "Paletli ürünler için 1.1x1.1m taban alanı ve %15 hacim artışı öngörülmüştür. Dökme parçalar için 0.90 pratik hacim faktörü uygulanmıştır.",
                res_summary: "SEVKİYAT ÖZETİ",
                lbl_tot_truck: "TOPLAM ARAÇ", lbl_tot_weight: "TOPLAM AĞIRLIK", lbl_avg_weight: "ORT. AĞIRLIK/ARAÇ",
                lbl_pipe_trucks: "BORU", lbl_fit_trucks: "FITTING", lbl_vol: "Hacim",
                rep_title: "SEVKİYAT YÜKLEME RAPORU", rep_by: "Raporlayan", rep_date: "Tarih", rep_v_type: "Araç Tipi",
                rep_gen_list: "1. GENEL ÜRÜN LİSTESİ", rep_desc: "Ürün Tanımı", rep_unit: "Birim", rep_qty: "Miktar",
                rep_load_det: "2. YÜKLEME DETAYLARI", rep_nesting: "BORU YERLEŞİM (NESTING):", rep_part_list: "PARÇA LİSTESİ:",
                rep_size: "Boyut", rep_pack: "Paket", rep_work_order: "YÜKLEME İŞ EMİRİ:",
                step_floor: "ADIM 1: PALETLİ YÜKLERİN YERLEŞİMİ", step_loose: "ADIM 2: DÖKME PARÇALARIN YERLEŞİMİ",
                lbl_pkg_content: "PAKET İÇERİĞİ (TOPLAM METRAJ):",
                lbl_custom_name: "Parça Adı", 
                lbl_dim_l: "Boy(mm)", 
                lbl_dim_w: "En(mm)", 
                lbl_dim_h: "Yük(mm)", 
                lbl_weight_u: "Birim Kg",
                // YENİ ÇEVİRİLER
                lbl_nest_gap: "NESTING GÜVENLİK (mm)",
                opt_safe_50: "50 mm (Standart)",
                opt_safe_35: "35 mm (Riskli)", // DEĞİŞTİRİLDİ
                opt_alt_load: "Şaşırtmalı Yükleme (Risk Azaltma)",
                lbl_pallet_dims: "PALET ÖLÇÜLERİ (mm)",
                unit_adet: "Adet"
            },
            en:{
                app_title:"Gpack X",app_desc:"GRP Pipe & Fitting Packing Optimiser",btn_pdf:"DOWNLOAD PDF",btn_word:"DOWNLOAD WORD",
                sec_settings:"SHIPMENT SETTINGS",lbl_user:"USER",lbl_project:"PROJECT REFERENCE",lbl_vehicle:"VEHICLE TYPE",lbl_limits:"VEHICLE LIMITS",
                lim_l:"LENGTH (m)",lim_w:"WIDTH (m)",lim_h:"HEIGHT (m)",lim_kg:"CAPACITY (Ton)",
                tab_list_pipe:"ADD PIPE",tab_list_fit:"ADD FITTING",
                lbl_dn:"DIAMETER (DN)",lbl_pn:"PN",lbl_sn:"SN",opt_cpl:"Coupling",opt_plain:"Plain End",lbl_len:"PIPE LEN (m)",lbl_total:"TOTAL (m)",btn_add_pipe:"ADD",
                fit_plan_title:"LOADING DETAILS",lbl_type:"ITEM TYPE",lbl_pack:"PACKAGING",opt_loose:"Loose",opt_pallet:"Pallet",lbl_qty:"QTY",btn_add_fit:"ADD",
                sec_list:"PRODUCTION LIST",btn_clear:"CLEAR",
                th_desc:"Desc",th_len:"Len",th_total:"Total",th_det:"Detail",th_pack:"Pack",th_dim:"Dim",th_qty:"Qty",
                btn_calc:"CALCULATE & PLAN",res_title:"Loading Plan Results",
                sec_res_pipe:"SECTION 1: PIPE SHIPMENT",sec_res_fit:"SECTION 2: FITTING SHIPMENT",
                type_tee:"TEE",type_bend:"Elbow",type_red:"Reducer",type_flg:"Flange",type_cpl:"Coupling",type_custom:"Custom Item", 
                opt_empty:"None",
                dim_main:"DIAMETER", dim_in:"Inlet", dim_out:"Outlet", dim_br:"Branch", dim_len:"Len", dim_h:"Branch Len", dim_ang:"Angle", dim_arm:"Arm",
                lbl_opt_in:"Inlet Option", lbl_opt_out:"Outlet Option", lbl_opt_br:"Branch Option",
                truck:"TRUCK",tr_std:"Standard Truck (13.60m)",tr_40hc:"40\" HC",tr_40ot:"40\" OT",tr_20dc:"20\" DC",tr_low:"Lowbed Truck",
                err_limits_exceeded: "WARNING: Limit Exceeded", lbl_weight: "Unit Kg",
                lbl_username:"USERNAME", lbl_password:"PASSWORD", btn_login:"LOGIN", app_ver:"V2.11 | GRP Pipe & Fitting Packing Optimiser",
                lbl_assumptions: "CALCULATION ASSUMPTIONS:",
                note_1: "Standard catalog dimensions are used for pipes and fittings.",
                note_2: "Lamination weights are excluded from fitting weight calculations.",
                note_3: "Vehicle weight and footprint utilization data indicates the occupancy ratio relative to vehicle capacity (volume and area).",
                note_4: "Pipe and fitting weights are calculated as standard and may vary by manufacturer.",
                note_5: "Palletized products assume a 1.1x1.1m base area and a 15% volume increase. Loose parts assume a 0.90 practical volume factor.",
                res_summary: "SHIPMENT SUMMARY",
                lbl_tot_truck: "TOTAL TRUCKS", lbl_tot_weight: "TOTAL WEIGHT", lbl_avg_weight: "AVG WEIGHT/TRUCK",
                lbl_pipe_trucks: "PIPE", lbl_fit_trucks: "FITTING", lbl_vol: "Volume",
                rep_title: "SHIPMENT LOADING REPORT", rep_by: "Reported By", rep_date: "Date", rep_v_type: "Vehicle Type",
                rep_gen_list: "1. GENERAL PRODUCT LIST", rep_desc: "Description", rep_unit: "Unit", rep_qty: "Qty",
                rep_load_det: "2. LOADING DETAILS", rep_nesting: "PIPE NESTING LAYOUT:", rep_part_list: "PARTS LIST:",
                rep_size: "Size", rep_pack: "Pack", rep_work_order: "LOADING INSTRUCTIONS:",
                step_floor: "STEP 1: PALLET LOADING", step_loose: "STEP 2: LOOSE ITEMS LOADING",
                lbl_pkg_content: "PACKAGE CONTENT (TOTAL LENGTH):",
                lbl_custom_name: "Item Name", 
                lbl_dim_l: "Length(mm)", 
                lbl_dim_w: "Width(mm)", 
                lbl_dim_h: "Height(mm)", 
                lbl_weight_u: "Unit Kg",
                // YENİ ÇEVİRİLER
                lbl_nest_gap: "NESTING SAFETY (mm)",
                opt_safe_50: "50 mm (Standard)",
                opt_safe_35: "35 mm (Risky)", // DEĞİŞTİRİLDİ
                opt_alt_load: "Alternating Load (Risk Reduction)",
                lbl_pallet_dims: "PALLET DIMENSIONS (mm)",
                unit_adet: "Pcs"
            }
        };
        let currentLang='tr'; 
        function t(key){return TRANSLATIONS[currentLang][key]||key}

        // --- VISUAL ASSETS (SVG) ---
        const FIT_ICONS = {
            TEE: `<svg viewBox="0 0 100 100" fill="currentColor"><path d="M10 35 H35 V10 H65 V35 H90 V65 H10 Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
            BEND: `<svg viewBox="0 0 100 100" fill="currentColor"><path d="M20 90 V50 A 30 30 0 0 1 50 20 H90 V50 H60 A 10 10 0 0 0 50 60 V90 Z" stroke="currentColor" stroke-width="2" fill="none"/></svg>`,
            RED: `<svg viewBox="0 0 100 100" fill="currentColor"><path d="M25 25 H75 L 60 75 H40 Z" stroke="currentColor" stroke-width="2" fill="none"/><line x1="25" y1="25" x2="75" y2="25" stroke="currentColor" stroke-width="2"/><line x1="40" y1="75" x2="60" y2="75" stroke="currentColor" stroke-width="2"/></svg>`,
            FLG: `<svg viewBox="0 0 100 100" fill="currentColor"><circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="3" fill="none"/><circle cx="50" cy="50" r="15" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="50" cy="25" r="3" fill="currentColor"/><circle cx="50" cy="75" r="3" fill="currentColor"/><circle cx="25" cy="50" r="3" fill="currentColor"/><circle cx="75" cy="50" r="3" fill="currentColor"/></svg>`,
            CPL: `<svg viewBox="0 0 100 100" fill="currentColor"><rect x="20" y="30" width="60" height="40" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="50" y1="30" x2="50" y2="70" stroke="currentColor" stroke-width="1" stroke-dasharray="4"/></svg>`,
            CUSTOM: `<i class="fas fa-boxes text-5xl opacity-80"></i>`
        };
        
        // --- LOGIN LOGIC ---
        function checkLogin() {
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();
            if(!u) return alert(t("Kullanıcı adı giriniz."));

            const vowels = (u.match(/[aeiouıüöçşAEIOUİÜÖÇŞ]/g) || []).length;
            const consonants = u.length - vowels;
            const correctPass = `${vowels}0${consonants}0${u.length}`;

            if(p === correctPass) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainAppContent').classList.remove('hidden');
                document.getElementById('txtUser').value = u.toUpperCase();
            } else {
                alert(t("Hatalı şifre!"));
            }
        }

        // --- DN / AĞIRLIK / TAŞIMA VERİ TABANLARI ---
        const REAL_ODS={100:110,150:160,200:210,250:260,300:324,350:376.4,400:427.3,450:475.8,500:530.3,600:633,700:718.5,800:820.5,900:924,1000:1026.5,1100:1125.5,1200:1229,1300:1331.5,1400:1433.5,1500:1536.5,1600:1638.5,1700:1739.5,1800:1841.5,1900:1944.5,2000:2046,2100:2148.5,2200:2250.5,2300:2354,2400:2454,2500:2553.5,2600:2657.5,2700:2758.5,2800:2858.5,2900:2962.5,3000:3065,3100:3166.5,3200:3269,3300:3370.5,3400:3473,3500:3574.5,3600:3676.5,3700:3778.5,3800:3880.5,3900:3982.5,4000:4085};
        const GRP_WEIGHT_DB = {
            300: 16, 350: 21, 400: 27, 450: 34, 500: 42, 600: 61,
            700: 82, 800: 107, 900: 136, 1000: 165, 1200: 240,
            1400: 330, 1600: 430, 1800: 550, 2000: 680, 2200: 820,
            2400: 975, 2600: 1150, 2800: 1330, 3000: 1530, 4000: 2700
        };
        const TRANSPORT_KEYS=['tr_std','tr_40hc','tr_40ot','tr_20dc','tr_low'];
        const TRANSPORT_DATA={
            // GÜNCELLEME: tr_std için W: 2.55 yapıldı
            'tr_std':{L:13.60,W:2.55,H:2.70,MaxKg:24500},
            'tr_40hc':{L:12.00,W:2.34,H:2.68,MaxKg:26500},
            'tr_40ot':{L:12.00,W:2.34,H:2.35,MaxKg:26500},
            'tr_20dc':{L:5.90,W:2.34,H:2.39,MaxKg:28000},
            'tr_low':{L:13.50,W:3.00,H:3.50,MaxKg:35000}
        };

        // --- YENİ DİRSEK (ELBOW) TABLOSU VERİSİ (KISALTILMIŞ) ---
        const ELBOW_DB = [
            {dn: 300, R: 450, 11.25: 275, 22.5: 300, 30: 325, 45: 400, 60: 500, 90: 700},
            {dn: 400, R: 600, 11.25: 300, 22.5: 325, 30: 375, 45: 475, 60: 650, 90: 850},
            {dn: 500, R: 750, 11.25: 325, 22.5: 375, 30: 400, 45: 525, 60: 625, 90: 950},
            {dn: 600, R: 900, 11.25: 325, 22.5: 400, 30: 450, 45: 600, 60: 700, 90: 1075},
            {dn: 1000, R: 1270, 11.25: 425, 22.5: 500, 30: 575, 45: 750, 60: 925, 90: 1450},
            {dn: 2000, R: 2070, 11.25: 700, 22.5: 800, 30: 900, 45: 1300, 60: 1500, 90: 2400},
            {dn: 4000, R: 4100, 11.25: 1700, 22.5: 1800, 30: 2000, 45: 2400, 60: 2600, 90: 4400}
        ];
        
        // REDUCER DATABASE (KISALTILMIŞ)
        const REDUCER_DB = {
            300: {200:1050, 250:925}, 500: {350:1175, 400:1050}, 1000: {800:1300, 900:1050},
            2000: {1600:2200, 1800:1700}, 4000: {3800:2700, 3900:2450}
        };

        const FLANGE_WEIGHT_EST = {300: 6, 350: 8, 400: 11, 450: 14, 500: 18, 600: 25, 700: 35, 800: 45, 900: 60, 1000: 70, 1200: 95, 1400: 130, 1600: 170, 1800: 210, 2000: 250, 2400: 350, 3000: 550};
        const COUPLING_DIMENSIONS = {
            get: function(dn, pn) {
                let w = 0;
                // Manşon Genişliği (W)
                if (dn <= 350) w = 220; else if (dn <= 600) w = 242;
                else if (dn <= 1300) w = 260; else if (dn <= 2400) w = 275; else w = 330;
                
                let de = dn + 60; 
                const specificDe = { 2000: {10: 2100, 16: 2110, 20: 2120}, 600: {10: 670, 16: 680, 20: 690}, 1000: {10: 1070, 16: 1080, 20: 1090}, 1600: {10: 1690, 16: 1700, 20: 1710} };
                if (specificDe[dn] && specificDe[dn][pn]) { de = specificDe[dn][pn]; } else {
                    let factor = 60;
                    if (dn > 1000) factor = 80; if (dn > 2000) factor = 100;
                    if (dn > 3000) factor = 130;
                    if (pn >= 16) factor += 10;
                    if (pn >= 25) factor += 20;
                    if (pn == 20) factor += 15; 
                    de = dn + factor;
                }
                return { w: w, de: de };
            }
        };
        const ELBOW_ANGLES = [90, 60, 45, 30, 22.5, 11.25];
        const getNearestElbowAngle = (inputAngle) => {
            if (inputAngle >= 90) return 90;
            if (inputAngle <= ELBOW_ANGLES[ELBOW_ANGLES.length - 1]) return ELBOW_ANGLES[ELBOW_ANGLES.length - 1];
            let nearest = ELBOW_ANGLES[0];
            let minDiff = Math.abs(inputAngle - nearest);
            for (const angle of ELBOW_ANGLES) {
                const diff = Math.abs(inputAngle - angle);
                if (diff < minDiff) {
                    minDiff = diff;
                    nearest = angle;
                }
            }
            return nearest;
        };
        // --- TEE KATALOG VERİ TABANI (KISALTILMIŞ) ---
        const TEE_DB_MIN = {
            300: { 300: { PN10: {L:1000,H:450}, PN16: {L:1200,H:550} } },
            2000: { 2000: { PN10: {L:4000,H:1970}, PN16: {L:5000,H:2470} } }
        };
        
        let pipeItems=[], fittingItems=[], finalPackages=[];
        
        window.onload=()=>{
            changeLanguage('tr'); 
            renderFitDynamic();
            document.getElementById('alternatingLoad').addEventListener('change', (e) => updateAssumptionNotes(e.target.checked));
            document.getElementById('nestingGap').addEventListener('change', (e) => updateAssumptionNotes(document.getElementById('alternatingLoad').checked));
        };

        function changeLanguage(lang){
            currentLang=lang; document.documentElement.lang=lang; document.documentElement.dir='ltr';
            
            // NOTE 5 CLEANUP
            if(lang === 'tr'){
                TRANSLATIONS.tr.note_5 = "Paletli ürünler için 1.1x1.1m taban alanı ve %15 hacim artışı öngörülmüştür. Dökme parçalar için 0.90 pratik hacim faktörü uygulanmıştır.";
            } else {
                TRANSLATIONS.en.note_5 = "Palletized products assume a 1.1x1.1m base area and a 15% volume increase. Loose parts assume a 0.90 practical volume factor.";
            }

            document.querySelectorAll('[data-key]').forEach(el=>el.innerText=t(el.getAttribute('data-key')));
            document.getElementById('langSelectMain').value = lang;
            document.querySelector('#fitPackSelect option[value="Pallet"]').innerText = t('opt_pallet');
            document.querySelector('#fitPackSelect option[value="Loose"]').innerText = t('opt_loose');
            
            // YENİ ÇEVİRİLERİ GÜNCELLE
            document.querySelector('#nestingGap option[value="50"]').innerText = t('opt_safe_50');
            document.querySelector('#nestingGap option[value="35"]').innerText = t('opt_safe_35');

            
            populatePipeDN();
            populateFitTypeOptions(); 
            
            populateVehicleOptions();
            renderPipeList(); renderFitList(); renderFitDynamic();
            document.getElementById('app_title').innerText = t('app_title');
            
            updateAssumptionNotes(document.getElementById('alternatingLoad').checked);
        }

        function updateAssumptionNotes(altLoad){
            const nestGap = document.getElementById('nestingGap').value;
            const gapLabel = nestGap === '50' ? t('opt_safe_50') : t('opt_safe_35');
            const cplLenText = altLoad ? (currentLang==='tr'?'tam manşon boyu':'full coupling length') : (currentLang==='tr'?'yarım manşon boyu':'half coupling length');
            const loadType = altLoad ? (currentLang==='tr'?'Şaşırtmalı Yükleme':'Alternating Load') : (currentLang==='tr'?'Düz Yükleme':'Flat Load');

            document.getElementById('note_6').innerHTML = currentLang === 'tr' 
                ? `Boru iç içe yerleşiminde (Nesting) ${nestGap}mm (${gapLabel}) güvenlik mesafesi kullanılmıştır.`
                : `Pipe Nesting uses a ${nestGap}mm (${gapLabel}) safety gap.`;
            document.getElementById('note_7').innerHTML = currentLang === 'tr' 
                ? `Manşonlu borular için ${cplLenText} ek uzunluk kullanılmıştır (${loadType}).`
                : `Coupling pipes use ${cplLenText} extra length (${loadType}).`;
        }
        
        function toggleElement(id, iconId) {
            const el = document.getElementById(id), icon = document.getElementById(iconId);
            if(el.classList.contains('hidden')){ el.classList.remove('hidden'); icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up'); }
            else { el.classList.add('hidden'); icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down'); }
        }

        function switchTab(type) {
            const tPipe = document.getElementById('tabPipe'), tFit = document.getElementById('tabFit');
            const cPipe = document.getElementById('pipeContent'), cFit = document.getElementById('fitContent');
            if (type === 'pipe') {
                tPipe.className = "tab-btn tab-active flex-1 flex items-center justify-center gap-2";
                tFit.className = "tab-btn tab-inactive flex-1 flex items-center justify-center gap-2";
                cPipe.classList.remove('hidden'); cFit.classList.add('hidden');
            } else {
                tPipe.className = "tab-btn tab-inactive flex-1 flex items-center justify-center gap-2";
                tFit.className = "tab-btn tab-active flex-1 flex items-center justify-center gap-2";
                cPipe.classList.add('hidden'); cFit.classList.remove('hidden');
            }
        }

        function populateVehicleOptions(){const s=document.getElementById('transportType');s.innerHTML='';TRANSPORT_KEYS.forEach(k=>{let o=document.createElement('option');o.value=k;o.text=t(k);s.add(o)});loadTransportLimits();}
        function loadTransportLimits(){
            const d=TRANSPORT_DATA[document.getElementById('transportType').value]||TRANSPORT_DATA['tr_std'];
            document.getElementById('maxL').value=d.L;
            document.getElementById('maxW').value=d.W;
            document.getElementById('maxH').value=d.H;
            document.getElementById('maxWeight').value=d.MaxKg / 1000;
        }
        function populatePipeDN(){const s=document.getElementById('pipeDN');s.innerHTML='';Object.keys(REAL_ODS).map(Number).filter(x=>x>=300).sort((a,b)=>a-b).forEach(d=>{let o=document.createElement('option');o.value=d;o.text=`DN ${d}`;s.add(o)});s.value="1000";}
        
        function populateFitTypeOptions() {
            const s = document.getElementById('fitType');
            s.innerHTML = '';
            ['tee', 'bend', 'red', 'flg', 'cpl', 'custom'].forEach(k => { let o = document.createElement('option'); o.value = k.toUpperCase(); o.text = t('type_' + k); s.add(o); });
            s.value = 'BEND'; 
        }

        function updateFitDNs() {
            const type = document.getElementById('fitType').value, mainDNEl = document.getElementById('fd1'), secondaryDNEl = document.getElementById('fd2');
            if (!mainDNEl || (type === 'TEE' && !secondaryDNEl)) return;
            const mainDN = parseInt(mainDNEl.value);
            const allDNs = Object.keys(REAL_ODS).map(Number).sort((a,b)=>b-a);
            let filteredDNs = [];
            
            if (type === 'RED' || type === 'REDUCER') {
                filteredDNs = allDNs.filter(dn => dn < mainDN && dn >= mainDN - 300).sort((a,b) => b-a);
            } else if (type === 'TEE') { 
                filteredDNs = allDNs.filter(dn => dn <= mainDN).sort((a,b) => b-a);
            }
            
            if (secondaryDNEl) {
                if (filteredDNs.length === 0 && (type === 'RED' || type === 'TEE')) {
                    secondaryDNEl.innerHTML = `<option value="">N/A</option>`;
                } 
                else if (type === 'RED' || type === 'TEE') { 
                    secondaryDNEl.innerHTML = filteredDNs.map(dn => `<option value="${dn}">DN${dn}</option>`).join('');
                    secondaryDNEl.value = filteredDNs[0].toString(); 
                }
            }
            fillDim();
        }
        
        const endOptions = [
            { value: '', textKey: 'opt_empty', weightFactor: 0 },
            { value: 'Cpl', textKey: 'type_cpl', weightFactor: 1 },
            { value: 'Flg', textKey: 'type_flg', weightFactor: 1.5 }
        ];
        function getEndOptionsHTML(prefix) {
            const labelKey = 'lbl_opt_' + prefix.toLowerCase();
            return `<div class="w-28"><label class="compact-label">${t(labelKey)}</label><select id="o_${prefix}" class="input-std h-[30px] w-full py-0 text-[10px] font-semibold">` + 
                   endOptions.map(opt => `<option value="${opt.value}" data-weight="${opt.weightFactor}">${t(opt.textKey)}</option>`).join('') + 
                   `</select></div>`;
        }
        
        function renderFitDynamic() {
            const s = document.getElementById('fitType');
            const c = document.getElementById('fitDynamic'), o = document.getElementById('fitOptions');
            const snDiv = document.getElementById('divFitSN');
            
            const previewDiv = document.getElementById('fitPreviewImg');
            const previewLbl = document.getElementById('fitPreviewLabel');
            let typeKey = s.value;
            if(typeKey === 'REDUCER') typeKey = 'RED';
            if(typeKey === 'COUPLING') typeKey = 'CPL';
            if(typeKey === 'FLANGE') typeKey = 'FLG';
            if(typeKey === 'CUSTOM') typeKey = 'CUSTOM'; 
            
            if(previewDiv) {
                previewDiv.innerHTML = FIT_ICONS[typeKey] || FIT_ICONS['TEE'];
                previewLbl.innerText = t('type_' + s.value.toLowerCase());
            }

            if(s.value === 'CPL' || s.value === 'COUPLING' || s.value === 'CUSTOM') snDiv.classList.add('hidden'); 
            else snDiv.classList.remove('hidden');
            
            const mainOpts = Object.keys(REAL_ODS).map(Number).filter(x=>x>=300).sort((a,b)=>a-b).map(d=>`<option value="${d}" ${d==600?'selected':''}>DN${d}</option>`).join('');
            
            const f=(l,i)=>`<div class="w-16"><label class="compact-label">${t(l)}</label><input type="number" id="${i}" class="input-std h-[30px] w-full text-center"></div>`;
            const slMain=(l,i, func='updateFitDNs')=>`<div class="w-24"><label class="compact-label">${t(l)}</label><select id="${i}" class="input-std h-[30px] w-full py-0" onchange="${func}()">${mainOpts}</select></div>`;
            const slSec=(l,i)=>`<div class="w-20"><label class="compact-label">${t(l)}</label><select id="${i}" class="input-std h-[30px] w-full py-0" onchange="fillDim()"></select></div>`;
            
            let h='', optionsHTML = ''; const v=s.value;
            if(v==='TEE'){ 
                h=slMain('dim_main','fd1')+slSec('dim_out','fd2')+f('dim_len','fL')+f('dim_h','fH_branch_len') + `<input type="hidden" id="fH_center" value="1070">`;
                optionsHTML = getEndOptionsHTML('IN') + getEndOptionsHTML('OUT') + getEndOptionsHTML('BR');
            }
            else if(v==='BEND'){ 
                const angleOptions = ELBOW_ANGLES.map(a => `<option value="${a}" ${a==90?'selected':''}>${a}°</option>`).join('');
                h=slMain('dim_main','fd1', 'fillDim')+`<div class="w-16"><label class="compact-label">${t('dim_ang')}</label><select id="fangSelect" class="input-std h-[30px] w-full py-0 text-center" onchange="fillDim()">${angleOptions}</select></div>`+f('dim_arm','fL');
                optionsHTML = getEndOptionsHTML('IN') + getEndOptionsHTML('OUT');
            }
            else if(v==='RED'||v==='REDUCER'){ 
                h=slMain('dim_main','fd1')+slSec('dim_out','fd2')+f('dim_len','fL');
                optionsHTML = getEndOptionsHTML('IN') + getEndOptionsHTML('OUT');
            }
            else if(v==='FLG'||v==='FLANGE'){ 
                h=slMain('dim_main','fd1', 'fillDim')+f('dim_len','fL');
            } 
            else if(v==='CPL' || v==='COUPLING'){
                h=slMain('dim_main','fd1', 'fillDim');
                optionsHTML = ''; 
            }
            else if(v==='CUSTOM') {
                h = `
                    <div class="w-40 flex-1 min-w-[120px]">
                        <label class="compact-label text-teal-800" data-key="lbl_custom_name">${t('lbl_custom_name')}</label>
                        <input type="text" id="custName" class="input-std h-[30px] w-full py-0" placeholder="...">
                    </div>
                    <div class="w-16"><label class="compact-label text-teal-800" data-key="lbl_dim_l">${t('lbl_dim_l')}</label><input type="number" id="custL" value="1000" class="input-std h-[30px] w-full text-center"></div>
                    <div class="w-16"><label class="compact-label text-teal-800" data-key="lbl_dim_w">${t('lbl_dim_w')}</label><input type="number" id="custW" value="1000" class="input-std h-[30px] w-full text-center"></div>
                    <div class="w-16"><label class="compact-label text-teal-800" data-key="lbl_dim_h">${t('lbl_dim_h')}</label><input type="number" id="custH" value="1000" class="input-std h-[30px] w-full text-center"></div>
                    <div class="w-20"><label class="compact-label text-teal-800" data-key="lbl_weight_u">${t('lbl_weight_u')}</label><input type="number" id="custKg" value="50" class="input-std h-[30px] w-full text-center font-bold text-teal-700"></div>
                `;
                optionsHTML = '';
                snDiv.classList.add('hidden');
            }
            c.innerHTML=h; o.innerHTML=optionsHTML; 
            
            if(v==='TEE'||v==='RED'||v==='REDUCER'){ updateFitDNs();
            } else { fillDim(); }
        }

        function findElbowDimension(dn, angle) {
            const item = ELBOW_DB.find(e => e.dn === dn);
            const angleKey = angle.toString();
            
            if (item && item[angleKey] !== undefined) {
                return item[angleKey];
            }

            // Fallback 1: Aynı DN'de bir sonraki büyük açı değeri
            if (item) {
                const availableAngles = ELBOW_ANGLES.filter(a => a > angle && item[a.toString()] !== undefined).sort((a, b) => a - b);
                if (availableAngles.length > 0) {
                    return item[availableAngles[0].toString()];
                }
            }

            // Fallback 2: DN tablo dışındaysa, R/2 kuralını kullan (Trigonometrik hesaplama)
            const fallbackR = item ? item.R : (dn * 1.5);
            return Math.round(fallbackR * Math.tan((angle * Math.PI / 180) / 2));
        }

        function fillDim(){
            const d1El = document.getElementById('fd1');
            if(!d1El) return;
            
            const t = document.getElementById('fitType').value;
            const d1 = parseInt(d1El.value);
            
            if(t === 'BEND'){
                const angle = parseFloat(document.getElementById('fangSelect').value);
                const kolBoyu = findElbowDimension(d1, angle);
                document.getElementById('fL').value = kolBoyu;
            } 
            else if (t === 'TEE'){
                const d2El = document.getElementById('fd2');
                const pnEl = document.getElementById('fitPN');
                if (!d2El || !pnEl) return;
                
                const d2 = parseInt(d2El.value);
                const pn = 'PN' + pnEl.value; 

                let L_val = 1800; 
                let H_val = 1070; 
                
                const teeData = TEE_DB[d1] || TEE_DB_MIN[d1]; // TEE_DB'nin dışardan tamamlandığı varsayılır.

                let finalTeeData = null;

                if (teeData && teeData[d2] && teeData[d2][pn]) {
                    finalTeeData = teeData[d2][pn];
                }
                
                if (finalTeeData) {
                    L_val = finalTeeData.L;
                    H_val = finalTeeData.H;
                }
                
                document.getElementById('fL').value = L_val;
                
                // Branş Boru Boyu (fH_branch_len) = H (Merkez Uzaklığı) - (Branş Çapı OD/2)
                const d2OD = REAL_ODS[d2] || d2 * 1.05;
                const branchPipeLen = Math.max(100, Math.round(H_val - (d2OD / 2)));
                
                document.getElementById('fH_branch_len').value = branchPipeLen;
                document.getElementById('fH_center').value = H_val; 
            }
            else if(t === 'RED' || t === 'REDUCER'){
                 const d2 = parseInt(document.getElementById('fd2').value);
                 let val = REDUCER_DB[d1] ? REDUCER_DB[d1][d2] : undefined;

                 if (val === undefined) {
                     const reducerData = REDUCER_DB[d1];
                     if (reducerData) {
                         const availableSmallDNs = Object.keys(reducerData).map(Number).sort((a, b) => a - b);
                         if (availableSmallDNs.length > 0) {
                             const smallestDN = availableSmallDNs[0];
                             val = reducerData[smallestDN];
                         }
                     }
                 }
                 
                 if (val === undefined) {
                     val = d1 * 1.5 + 300; 
                 }
                 
                 document.getElementById('fL').value = val;
            }
            else if(t === 'FLG' || t === 'FLANGE'){
                document.getElementById('fL').value = 600;
            }
        }
        
        function getFlangeWeight(dn, pn){
            let w = FLANGE_WEIGHT_EST[dn] || ((dn*dn)/16000 + 3);
            if(pn <= 6) return w * 0.7; 
            if(pn == 16) return w * 1.3;
            if(pn == 20) return w * 1.45; 
            if(pn == 25) return w * 1.8; 
            if(pn >= 32) return w * 2.2; 
            return w;
        }

        function getCouplingWeight(dn, pn) {
            const cplData = COUPLING_DIMENSIONS.get(dn, pn);
            return (Math.PI * dn/1000 * cplData.w/1000 * 0.03 * 1800);
        }
        
        // REVİZYON: Manşon uzunluğu (w) 
        function getCouplingWidth(dn, pn) {
            return COUPLING_DIMENSIONS.get(dn, pn).w; // mm cinsinden
        }

        function getPipeWeightPerMeter(dn, pn, sn) {
            let baseW = GRP_WEIGHT_DB[dn];
            if (!baseW) { baseW = dn * 0.165; }
            
            // YENİ REVİZYON: DN'ye özel ağırlık çarpanları (DN1700: 1.7x, DN2100: 2.2x, DN2700: 2.8x)
            let customFactor = 1.0;
            if (dn === 1700) customFactor = 1.7;
            else if (dn === 2100) customFactor = 2.2;
            else if (dn === 2700) customFactor = 2.8;
            
            let snFactor = 1.0;
            // SN2500 kaldırıldı
            if (sn == 5000) snFactor = 0.85; 
            if (sn == 15000) snFactor = 1.15;
            if (sn >= 20000) snFactor = 1.25;
            let pnFactor = 1.0;
            if (pn <= 6) pnFactor = 0.8;
            if (pn == 16) pnFactor = 1.2;
            if (pn == 20) pnFactor = 1.3; 
            if (pn == 25) pnFactor = 1.5;
            if (pn >= 32) pnFactor = 1.8;
            
            return baseW * snFactor * pnFactor * customFactor; // Yeni çarpan eklendi
        }
        
        function reCalculatePipeItem(item) {
            const d=item.dn, p=item.pn, s=item.sn, c=item.hasCpl, l=item.len, t=item.total;
            
            // Manşonlu borular için ek uzunluk hesaplaması
            const altLoad = document.getElementById('alternatingLoad').checked;
            let extraLength = 0; // Metre cinsinden
            
            if(c) {
                 const cplW_mm = getCouplingWidth(d, p);
                 if (altLoad) {
                     // Şaşırtmalı yüklemede tam manşon boyu kadar uzamış varsayılır.
                     extraLength = cplW_mm / 1000;
                 } else {
                     // Standart yüklemede sadece manşonun yarısı kadar (w_mm/2) uzamış varsayılır.
                     extraLength = (cplW_mm / 2) / 1000;
                 }
            }

            let calcLen = l + extraLength;
            let wpm = getPipeWeightPerMeter(d, p, s);
            
            // Borunun birim ağırlığı: Nominal ağırlık + (Manşon ağırlığı / 2)
            let unitW = (wpm * l) + (c ? (getCouplingWeight(d, p) / 2) : 0);
            
            item.effectiveLen = calcLen;
            item.unitW = unitW;
        }

        function addPipeToList(){
            const d=parseInt(document.getElementById('pipeDN').value),p=parseInt(document.getElementById('pipePN').value),s=parseInt(document.getElementById('pipeSN').value),c=document.getElementById('pipeCpl').checked,l=parseFloat(document.getElementById('pipeLen').value),t=parseFloat(document.getElementById('pipeTotal').value);
            if(t<=0 || l<=0)return alert(t("Total length required"));
            
            let item = {id:Date.now(),dn:d,pn:p,sn:s,hasCpl:c,len:l, effectiveLen: 0, total:t, unitW: 0, unit: 'm'};
            reCalculatePipeItem(item);
            pipeItems.push(item);
            renderPipeList();
        }

        function updatePipeItem(index, field, value) {
            let item = pipeItems[index];
            if (!item) return;

            if (field === 'len') {
                item.len = parseFloat(value);
            } else if (field === 'total') {
                item.total = parseFloat(value);
            } else if (field === 'unitW') {
                item.unitW = parseFloat(value);
            }
            
            reCalculatePipeItem(item);
            renderPipeList();
        }

        function updateFitItem(index, field, value) {
            let item = fittingItems[index];
            if (!item) return;

            if (field === 'qty') {
                item.qty = parseInt(value);
            } else if (field === 'w') {
                item.w = parseFloat(value);
            }
            
            item.reportDesc = generateReportDesc(item); 
            renderFitList();
        }

        function addFitToList(){
            const tp=document.getElementById('fitType').value;
            const d1El = document.getElementById('fd1');
            const d1 = parseInt((d1El ? d1El.value : 0) || 0);
            
            const d2El = document.getElementById('fd2');
            const d2 = d2El ? parseInt(d2El.value) : d1;

            const pn=parseInt(document.getElementById('fitPN').value);
            const snEl = document.getElementById('fitSN');
            const sn = (tp==='CPL' || tp==='COUPLING' || tp==='CUSTOM') ? 'N/A' : snEl.value; 
            const q=parseInt(document.getElementById('fitQty').value);
            const pk=document.getElementById('fitPackSelect').value;
            
            if((tp === 'RED' || tp === 'REDUCER')) { if (d2 > d1 - 100 || d2 < d1 - 300) return alert(`Hata: Redüksiyon (${d1}x${d2}) kural dışı.`);
            }
            if(tp === 'TEE' && d2 > d1) return alert(`Hata: Tee branş çapı büyük olamaz.`);
            
            const dns=0.0018,thk=d1*0.025; 
            let endDetails = [];

            const getEndData = (prefix, refDN) => {
                const el = document.getElementById(`o_${prefix}`);
                if (!el) return { type: 'Yok', factor: 0, text: t('opt_empty'), weight: 0, key: prefix, addedLen: 0 };
                const selectedOption = el.options[el.selectedIndex];
                const endType = selectedOption.value;
                const endText = selectedOption.text;
                let w = 0;
                let addedL = 0; // Metre cinsinden
                if(endType === 'Cpl') {
                    let cData = COUPLING_DIMENSIONS.get(refDN, pn);
                    w = getCouplingWeight(refDN, pn); 
                    addedL = (cData.w / 2) / 1000; 
                }
                else if(endType === 'Flg') {
                    w = getFlangeWeight(refDN, pn);
                    addedL = 100 / 1000; 
                }
                endDetails.push({ key: prefix, type: endType, text: endText, weight: w });
                return { type: endType, text: endText, weight: w, addedLen: addedL };
            };
            let i={id:Date.now(),isFitting:true,type:tp,dn:d1,pn:pn,sn:sn,qty:q,pack:pk,w:0,l:0,wid:0,h:0,vol:0,det:'',desc:'', endDetails: [], unit: 'Adet', disp_l: 0, disp_wid: 0};
            
            if(tp==='CUSTOM'){
                const custName = document.getElementById('custName').value.trim();
                const L = parseFloat(document.getElementById('custL').value);
                const W = parseFloat(document.getElementById('custW').value);
                const H = parseFloat(document.getElementById('custH').value);
                const unitW = parseFloat(document.getElementById('custKg').value);

                if (!custName || L <= 0 || W <= 0 || H <= 0 || unitW <= 0) {
                    return alert(t("Tüm özel parça alanlarını doldurunuz."));
                }
                
                i.desc = custName;
                i.l = L; i.wid = W; i.h = H;
                i.disp_l = L; i.disp_wid = W;
                i.w = unitW;
                i.det = t('opt_empty');
                i.pn = 'N/A'; i.sn = 'N/A';
            }
            else if(tp==='TEE'){
                // REVİZYON: Güvenli sayısal değer ataması
                let L = parseFloat(document.getElementById('fL').value) || 0;
                let CenterToFace = parseFloat(document.getElementById('fH_center').value) || 0; 
                
                if (L <= 0 || CenterToFace <= 0) {
                     return alert(`Hata: DN${d1}/${d2} Tee için boyut bilgileri (L: ${L}mm, H: ${CenterToFace}mm) geçerli değil. Lütfen DN/PN/SN seçiminden sonra boyutların doğru ayarlandığından emin olun.`);
                }
                
                i.desc=`DN${d1}/${d2} Tee`; i.disp_l = L; 
                let inEnd=getEndData('IN', d1), outEnd=getEndData('OUT', d1), brEnd=getEndData('BR', d2);
                i.l = L + (inEnd.addedLen + outEnd.addedLen) * 1000; // Effective L (mm)
                i.wid = CenterToFace + brEnd.addedLen * 1000; // Effective W (mm)
                i.disp_wid = CenterToFace;
                i.h = REAL_ODS[d1] || d1;
                
                // Ağırlık hesabı: L ve CenterToFace artık güvenli bir şekilde sayı.
                i.w = ((L / 1000 + CenterToFace / 1000)*Math.PI*(d1/1000)*thk*dns*1000); 
                i.w += (inEnd.weight + outEnd.weight + brEnd.weight);
                i.endDetails = endDetails;
            }
            else if(tp==='BEND'){
                let L=parseInt(document.getElementById('fL').value);
                const ang = parseFloat(document.getElementById('fangSelect').value) || 90;
                const usedAngle = getNearestElbowAngle(ang);
                i.desc=`DN${d1} Dirsek (${usedAngle}°)`; 
                let inEnd=getEndData('IN', d1), outEnd=getEndData('OUT', d1);
                i.disp_l = L;
                
                let elbowCF = L; 
                
                i.l = (elbowCF + Math.max(inEnd.addedLen, outEnd.addedLen) * 1000); // mm
                i.wid = i.l; 
                i.disp_wid = elbowCF;
                i.h = REAL_ODS[d1] || d1; // OD (mm)
                i.w = (elbowCF/1000*Math.PI*(d1/1000)*thk*dns*1000); // Ağırlık hesabı
                i.w += (inEnd.weight + outEnd.weight);
                i.endDetails = endDetails;
            }
            else if(tp==='CPL' || tp==='COUPLING'){
                const cplData = COUPLING_DIMENSIONS.get(d1, pn);
                i.desc=`DN${d1} ${t('type_cpl')}`; i.l = cplData.w; i.wid = cplData.de; i.h = cplData.de;
                i.disp_l = i.l; i.disp_wid = i.wid;
                i.h = REAL_ODS[d1] + 60 || d1 + 60; 
                i.w = getCouplingWeight(d1, pn);
                i.endDetails = [];
            }
            else if(tp.startsWith('RED')){
                let L=parseInt(document.getElementById('fL').value);
                i.desc=`DN${d1}/${d2} Reducer`; 
                let inEnd=getEndData('IN', d1), outEnd=getEndData('OUT', d2);
                i.disp_l = L;
                i.l = L + (inEnd.addedLen + outEnd.addedLen) * 1000; // mm
                i.wid = REAL_ODS[d1] || d1;
                i.h = REAL_ODS[d1] || d1; i.disp_wid = i.wid;
                i.w = (L/1000*Math.PI*(d1/1000)*thk*dns*1000);
                i.w += (inEnd.weight + outEnd.weight);
                i.endDetails = endDetails;
            }
            else {
                let L=parseInt(document.getElementById('fL').value);
                i.desc=`DN${d1} ${t('type_flg')}`; i.l=L; i.wid=d1*1.2; i.h=d1*1.2; 
                i.disp_l = L; i.disp_wid = i.wid;
                let pipeW = (L/1000*Math.PI*(d1/1000)*thk*dns*1000); i.w = pipeW;
                i.w += getFlangeWeight(d1, pn) * 2; 
                i.endDetails = []; 
            }
            
            i.w=Math.round(i.w);
            let detText = i.endDetails.filter(d => d.type !== '').map(d => `${d.key}:${d.text}`).join(', ');
            i.det = detText || t('opt_empty');
            if(tp==='CPL' || tp==='COUPLING' || tp==='FLG' || tp==='FLANGE' || tp==='CUSTOM') i.det = ""; 

            // Hacim Hesaplaması (Metre Küp)
            i.footprint = (i.l / 1000) * (i.wid / 1000);
            i.vol=(i.l/1000)*(i.wid/1000)*(i.h/1000); 
            // Paletli ve Dökme ürünler için hacim kaybı/artışı:
            if(pk==='Pallet') { 
                i.vol*=1.15; // %15 hacim artışı (dunnage, lashing vb.)
            } else {
                i.vol*=0.90; // %10 dökme kayıp
            }

            i.reportDesc = generateReportDesc(i);
            fittingItems.push(i); renderFitList(); 
        }

        function generateReportDesc(item) {
             if (item.isFitting) {
                if(item.type === 'CUSTOM') {
                    return `${item.desc} (${t('lbl_dim_l')}: ${item.l}x${item.wid}x${item.h}mm | ${t('lbl_weight_u')}: ${item.w}kg)`;
                }

                const pnSn = `(PN${item.pn}${item.sn!=='N/A'?' SN'+item.sn:''})`;
                let desc = item.desc;
                if(item.type === 'BEND') {
                    desc = `DN${item.dn} Dirsek (${item.desc.match(/\(([^)]+)\)/)?.[1] || 'Açı?'})`;
                }

                let endInfo = item.endDetails.filter(d => d.type !== '').map(d => {
                    let prefix = (d.key === 'IN' ? t('dim_in') : d.key === 'OUT' ? t('dim_out') : t('dim_br'));
                    let endType = t('type_' + d.type.toLowerCase()) || d.text;
                    return `${prefix}: ${endType}`;
                }).join(', ');
                
                return `${desc} ${pnSn} [${endInfo || t('opt_empty')}]`;
            } else {
                const cplStatus = item.hasCpl ? t('opt_cpl') : t('opt_plain');
                return `DN${item.dn} PN${item.pn} SN${item.sn} | ${item.len.toFixed(2)}m (${cplStatus})`;
            }
        }
        
        function renderPipeList(){
            const b=document.getElementById('tbodyPipe');b.innerHTML='';
            const cnt = pipeItems.length;
            document.getElementById('cntPipe').innerText=cnt; document.getElementById('cntPipeBadge').innerText=cnt;
            document.getElementById('pipeEmptyState').style.display = cnt > 0 ? 'none' : 'flex';
            pipeItems.forEach((p,i)=>{b.innerHTML+=`<tr class="hover:bg-blue-50/30 border-b border-blue-50 group"><td class="p-2 pl-3"><div class="font-bold text-slate-700">DN${p.dn}</div><div class="text-[9px] text-slate-400">PN${p.pn} SN${p.sn} ${p.hasCpl?`(+${t('opt_cpl')})`:''}</div></td><td class="p-2 text-center text-slate-600"><input type="number" step="0.01" min="0.5" class="editable-input editable-input-sm text-center" value="${p.len.toFixed(2)}" onchange="updatePipeItem(${i}, 'len', this.value)">m</td><td class="p-2 text-right font-mono font-bold text-blue-700"><input type="number" step="0.1" min="0" class="editable-input editable-input-lg text-center" value="${p.total.toFixed(1)}" onchange="updatePipeItem(${i}, 'total', this.value)">m</td><td class="p-2 text-center text-[10px]"><input type="number" step="1" min="1" class="editable-input editable-input-sm text-center" value="${Math.round(p.unitW)}" onchange="updatePipeItem(${i}, 'unitW', this.value)"></td><td class="p-2 text-right"><button onclick="pipeItems.splice(${i},1);renderPipeList()" class="text-blue-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></td></tr>`});
        }
        function renderFitList(){
            const b=document.getElementById('tbodyFit');b.innerHTML='';
            const cnt = fittingItems.length;
            document.getElementById('cntFit').innerText=cnt; document.getElementById('cntFitBadge').innerText=cnt;
            document.getElementById('fitEmptyState').style.display = cnt > 0 ? 'none' : 'flex';
            fittingItems.forEach((f,i)=>{
                const dimText = f.type === 'CUSTOM' 
                    ? `${f.l}x${f.wid}x${f.h}` 
                    : `${f.disp_l}x${Math.round(f.disp_wid)}`;
                const pnSnText = f.pn === 'N/A' 
                    ? '' 
                    : `PN${f.pn} ${f.sn!=='N/A'?`SN${f.sn}`:''}`;
                
                b.innerHTML+=`<tr class="hover:bg-teal-50/30 border-b border-teal-50 group"><td class="p-2 pl-3"><div class="font-bold text-slate-700">${f.desc}</div><div class="text-[9px] text-slate-400">${pnSnText}</div></td><td class="p-2 text-[9px] text-slate-500 leading-tight">${f.det||t('opt_empty')}</td><td class="p-2 text-center text-[9px] font-bold ${f.pack==='Pallet'?'text-teal-700 bg-teal-50 rounded':''}">${t(f.pack==='Pallet'?'opt_pallet':'opt_loose').toUpperCase()}</td><td class="p-2 text-center text-[10px] font-mono">${dimText}</td><td class="p-2 text-center font-bold"><input type="number" step="1" min="1" class="editable-input editable-input-sm text-center" value="${f.qty}" onchange="updateFitItem(${i}, 'qty', this.value)"></td><td class="p-2 text-center text-[10px]"><input type="number" step="1" min="1" class="editable-input editable-input-sm text-center" value="${f.w}" onchange="updateFitItem(${i}, 'w', this.value)"></td><td class="p-2 text-right"><button onclick="fittingItems.splice(${i},1);renderFitList()" class="text-teal-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></td></tr>`});
        }
        function clearPipes(){pipeItems=[];renderPipeList();document.getElementById('resultArea').classList.add('hidden');}
        function clearFits(){fittingItems=[];renderFitList();document.getElementById('resultArea').classList.add('hidden');}
        function checkPipeLimits(rP, lim) { 
             const altLoad = document.getElementById('alternatingLoad').checked;
             let errs = [];
            rP.forEach(p => { 
                if (p.effectiveLen > lim.L) errs.push(`Pipe DN${p.dn} exceeds length (Eff:${p.effectiveLen.toFixed(2)}m).`); 
                if (altLoad && p.hasC && (p.len + (getCouplingWidth(p.dn, p.pn)/1000)) > lim.L) errs.push(`Pipe DN${p.dn} (Cpl.) exceeds L: ${lim.L}m.`);
                if (lim.W < 3 && p.realOD/1000 > lim.W-0.1) errs.push(`Pipe DN${p.dn} exceeds width.`); 
            });
            return errs; 
        }

        // REVİZYON 6.2: Paletli ürünler için tek palet yüzey sınırlaması kaldırıldı, sadece TIR hacim/yüksekliğine bakılır.
        function checkFitLimits(fItems, lim) { 
            let errs = [];
            // Palet yüksekliği (metre)
            const palH = parseFloat(document.getElementById('palletH').value) / 1000;

            fItems.forEach(f => { 
                let w = f.wid / 1000, l = f.l / 1000, h = f.h / 1000, fits = false; 
                
                // Paletli ürünlerde efektif yükseklik: Ürün yüksekliği + Palet yüksekliği
                let effectiveH = (f.pack === 'Pallet') ? h + palH : h; 
                
                // TIR'a sığma kontrolü (Tüm yönelimler ve efektif yükseklik dikkate alınır)
                // Birden fazla palete izin verildiği için sadece TIR'ın L, W, H'si ile karşılaştırılır.
                fits = (l <= lim.L && w <= lim.W && effectiveH <= lim.H) ||
                       (l <= lim.L && w <= lim.H && effectiveH <= lim.W) ||
                       (w <= lim.L && l <= lim.W && effectiveH <= lim.H) ||
                       (w <= lim.L && l <= lim.H && effectiveH <= lim.W) ||
                       (effectiveH <= lim.L && l <= lim.W && w <= lim.H) ||
                       (effectiveH <= lim.L && w <= lim.W && l <= lim.H); 
                
                if (!fits) {
                     errs.push(`Fitting: ${f.desc} ${f.pack === 'Pallet' ? '(Paletli)' : '(Dökme)'} Truck'a sığmıyor. (L:${l.toFixed(2)}m, W:${w.toFixed(2)}m, H:${h.toFixed(2)}m -> Eff H:${effectiveH.toFixed(2)}m)`); 
                }
                if (f.w > lim.MaxKg) errs.push(`Fitting: ${f.desc} çok ağır. (${f.w}kg)`); 
            }); 
            return errs;
        }

        function groupIdenticalPackages(packages) {
            let groups = [];
            packages.forEach(pkg => {
                let signature = "";
                if (pkg.type === 'PIPE') { signature = pkg.items.map(item => getPipeSig(item)).join('|'); } 
                else { 
                     // FITTINGLERİ GRUPLARKEN SADECE RAPOR TANIMI YERİNE, TÜM PARÇA DETAYLARI KULLANILIR
                     signature = pkg.items.map(i => `${i.desc}_${i.sn}_${i.det}_${i.pack}`).sort().join('|'); 
                }
                let existingGroup = groups.find(g => g.sig === signature && g.type === pkg.type);
                if (existingGroup) { 
                    existingGroup.count++; 
                    existingGroup.ids.push(pkg.id); 
                    existingGroup.totalWeight += pkg.totalWeight; 
                    existingGroup.totalVol += pkg.totalVol;
                    if(pkg.totalFootprint) existingGroup.totalFootprint += pkg.totalFootprint; // Footprint'i topla
                } 
                else { 
                    groups.push({ 
                        sig: signature, 
                        type: pkg.type, 
                        sample: pkg, 
                        count: 1, 
                        ids: [pkg.id], 
                        baseWeight: pkg.totalWeight, 
                        totalWeight: pkg.totalWeight, 
                        totalVol: pkg.totalVol,
                        totalFootprint: pkg.totalFootprint || 0 // Footprint'i ekle
                    }); 
                }
            });
            groups.forEach(g => { g.ids.sort((a,b)=>a-b); const min = g.ids[0], max = g.ids[g.ids.length-1]; if(g.ids.length > 1 && (max - min === g.ids.length - 1)) g.labelID = `#${min} - #${max}`; else g.labelID = "#" + g.ids.join(', #'); });
            return groups;
        }

        // --- Diğer raporlama/görselleştirme fonksiyonları (Kısaltılmış) ---
        function getRW(p){let w=p.weight;if(p.children)p.children.forEach(c=>w+=getRW(c));return w;}
        function getPipeSig(p){
             let cp=p.hasC?(currentLang==='tr'?'Manşonlu':'Cpl'):(currentLang==='tr'?'Düz Uç':'Plain');
             let me=`DN${p.dn} PN${p.pn} SN${p.sn} (${p.nominalLen.toFixed(2)}m ${cp})`;
             if(p.children && p.children.length>0){ let kids = p.children.map(c => getPipeSig(c)).sort().join(' + ');
             return `${me} [Contains: ${kids}]`; } return me;
        }
        function getRecursiveHtml(p, indent=0){
             let cp=p.hasC?(currentLang==='tr'?'Manşonlu':'Cpl'):(currentLang==='tr'?'Düz Uç':'Plain');
             let h=`<div style="margin-left:${indent*20}px; ${indent>0?'color:#666; font-size:10px; margin-top:1px; border-left:2px solid #ddd; padding-left:5px;':''}">`;
             h+= `${indent>0?'↳ ':''}<b>DN${p.dn}</b> PN${p.pn} SN${p.sn} - ${p.nominalLen.toFixed(2)}m <span style="font-size:9px; color:#888;">(${cp})</span>`;
             h+=`</div>`; if(p.children) p.children.forEach(c => h += getRecursiveHtml(c, indent+1)); return h;
        }
        function renderFinalPlan(l){
            const c = document.getElementById('planContainer');
            c.innerHTML = ''; document.getElementById('resultArea').classList.remove('hidden');
            const groups = groupIdenticalPackages(finalPackages);
            const pt = groups.filter(g => g.type === 'PIPE'), ft = groups.filter(g => g.type === 'FITTING');
            const tPT = pt.reduce((s, g) => s + g.count, 0), tFT = ft.reduce((s, g) => s + g.count, 0), gT = tPT + tFT, tPW = pt.reduce((s, g) => s + g.totalWeight, 0), tFW = ft.reduce((s, g) => s + g.totalWeight, 0);
            
            const avgW = gT > 0 ? (tPW + tFW) / gT : 0;
            
            const vName = t(document.getElementById('transportType').value);

            // GÜNCEL VARSAYIMLARI EKLE
            const altLoad = document.getElementById('alternatingLoad').checked;
            updateAssumptionNotes(altLoad);


            const summaryHTML = `<div class="col-span-1 md:col-span-2 bg-white rounded-lg border border-slate-300 shadow-sm overflow-hidden mb-4 break-inside-avoid"><div class="bg-slate-800 text-white px-3 py-2 flex justify-between items-center"><div class="font-bold text-xs flex items-center gap-2"><i class="fas fa-chart-pie text-yellow-400"></i> <span>${t('res_summary')}</span></div><div class="text-[10px] opacity-70 font-mono">TOTAL: ${gT} ${t('truck')}</div></div><div class="p-3 grid grid-cols-2 md:grid-cols-5 gap-2"><div class="bg-slate-50 p-2 rounded border border-slate-200 text-center"><div class="text-[9px] text-slate-500 font-bold uppercase">${t('lbl_tot_truck')}</div><div class="text-xl font-bold text-slate-800">${gT}</div></div><div class="bg-slate-50 p-2 rounded border border-slate-200 text-center"><div class="text-[9px] text-slate-500 font-bold uppercase">${t('lbl_tot_weight')}</div><div class="text-lg font-bold text-slate-800">${((tPW+tFW)/1000).toFixed(2)}</div><div class="text-[9px] text-slate-400">Ton</div></div>
            <div class="bg-slate-50 p-2 rounded border border-slate-200 text-center"><div class="text-[9px] text-slate-500 font-bold uppercase">${t('lbl_avg_weight')}</div><div class="text-lg font-bold text-slate-800">${(avgW/1000).toFixed(2)}</div><div class="text-[9px] text-slate-400">Ton</div></div>
            <div class="bg-blue-50 p-2 rounded border border-blue-100 text-center"><div class="text-[9px] text-blue-600 font-bold uppercase">${t('lbl_pipe_trucks')}</div><div class="text-lg font-bold text-blue-800">${tPT} <span class="text-xs font-normal">${t('truck')}</span></div></div><div class="bg-teal-50 p-2 rounded border border-teal-100 text-center"><div class="text-[9px] text-teal-600 font-bold uppercase">${t('lbl_fit_trucks')}</div><div class="text-lg font-bold text-teal-800">${tFT} <span class="text-xs font-normal">${t('truck')}</span></div></div></div></div>`;
            c.innerHTML += summaryHTML;

            if(pt.length){ c.innerHTML+=`<div class="col-span-1 md:col-span-2 text-blue-800 font-bold border-b border-blue-200 pb-1 mt-1 flex justify-between"><span>${t('sec_res_pipe')}</span><span class="text-[10px] text-slate-500">${tPT} ${t('truck')}</span></div>`;
            pt.forEach(g => c.innerHTML += renderTruck(g, l, vName)); }
            if(ft.length){ c.innerHTML+=`<div class="col-span-1 md:col-span-2 text-teal-800 font-bold border-b border-teal-200 pb-1 mt-4 flex justify-between"><span>${t('sec_res_fit')}</span><span class="text-[10px] text-slate-500">${tFT} ${t('truck')}</span></div>`;
            ft.forEach(g => c.innerHTML += renderTruck(g, l, vName)); }
            document.getElementById('resultArea').scrollIntoView({behavior:'smooth'});
        }

        // REVİZYON 6.7: Hacim bilgileri kaldırıldı.
        function renderTruck(group, l, vehicleName) {
            const k = group.sample, count = group.count;
            const singleWeight = group.totalWeight / count;
            // const singleVol = group.totalVol / count; // Kaldırıldı
            
            const fW = Math.min(100, (singleWeight / l.MaxKg) * 100).toFixed(1);
            
            const cl = k.type === 'PIPE' ? 'blue' : 'teal', ic = k.type === 'PIPE' ? 'fas fa-truck' : 'fas fa-box-open';
            let cnt = '', sm = '';
            
            let statusHTML = `
                <div class="flex flex-col gap-1 mb-2">
                    <div class="flex justify-between items-center"><span class="text-[10px] font-bold text-slate-500">${currentLang==='tr'?'Araç Başı Ağırlık':'Weight per Truck'}</span><span class="text-[10px] font-bold text-${cl}-600">${(singleWeight/1000).toFixed(2)} Ton (%${fW})</span></div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-${cl}-500 h-1.5 rounded-full" style="width:${fW}%"></div></div>
                </div>
            `;
            
            // İstenen Değişiklik: Hacim bilgisi kaldırıldı.
            
            if (k.type === 'PIPE') {
                let grp = {};
                k.items.forEach(b => { let sig = getPipeSig(b); if (!grp[sig]) grp[sig] = { count: 0, html: getRecursiveHtml(b) }; grp[sig].count++; });
                let rows = Object.values(grp).map(g => `<tr><td class="text-[10px] p-1 align-top border-b border-slate-50">${g.html}</td><td class="text-[10px] text-right font-bold p-1 align-top border-b border-slate-50">${g.count}</td></tr>`).join('');
                cnt = `<table class="w-full mt-1 text-slate-600">${rows}</table>`;
                
                let s = {};
                k.items.forEach(b => {
                    const r = (p) => {
                        let ky = `DN${p.dn} PN${p.pn}`;
                        if (!s[ky]) s[ky] = 0;
                        s[ky] += p.nominalLen;
                        if (p.children) p.children.forEach(r)
                    };
                    r(b);
                });
                sm = `<div class="bg-blue-50 p-1.5 rounded mb-1 text-[9px] text-blue-900 grid grid-cols-2 gap-1">
                        <div class="col-span-2 font-bold border-b border-blue-200 mb-0.5" data-key="lbl_pkg_content">${t('lbl_pkg_content')}</div>
                        ${Object.entries(s).map(([k,v])=>`<div><b>${k}:</b> ${v.toFixed(1)}m</div>`).join('')}
                      </div>`;
            } else {
                let g = {};
                k.items.forEach(i => { let ky = `${i.reportDesc} ${i.pack}`; if (!g[ky]) g[ky] = { ...i, q: 0 }; g[ky].q++ });
                cnt = `<table class="w-full mt-1 text-slate-600">${Object.values(g).map(x => `<tr><td class="text-[10px] border-b border-slate-50 py-0.5">${x.reportDesc}</td><td class="text-[10px] text-right font-bold border-b border-slate-50">${x.q}</td></tr>`).join('')}</table>`;
                const packageData = finalPackages.find(p => p.id === k.id);
                if (packageData) {
                    sm = `<button onclick="showFitLayout(finalPackages.find(p => p.id === ${k.id}))" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-1 rounded text-[9px] mt-1 transition">${t('fit_plan_title')}</button>`;
                } else {
                    sm = `<span class="text-red-500 text-[9px] font-bold">DETAY YÜKLENEMEDİ</span>`;
                }
            }
            return `<div class="plan-card"><div class="p-2 flex justify-between items-center text-white bg-${cl}-800" style="${count>1?'background:linear-gradient(45deg, #1e293b, #334155)':''}"><div><i class="${ic} mr-1"></i> ${vehicleName} ${group.labelID}</div><div class="text-[10px]">${count>1?`<b>x${count}</b>`:''}</div></div><div class="p-2">${statusHTML}${sm}<div class="max-h-[180px] overflow-y-auto">${cnt}</div></div></div>`;
        }
        
        // --- REVİZYON 5: YENİ canNest FONKSİYONU ---
        function canNest(host, guest) {
            const nestGap_mm = parseInt(document.getElementById('nestingGap').value);
            // Basit Nesting Kuralı: İç boru (guest) Dış borunun (host) İç Çapından (OD'nin %97'si) en az 'nestGap_mm' daha küçük olmalı.
            const hostID = host.realOD * 0.97; // mm cinsinden İç Çap
            return hostID > guest.realOD + nestGap_mm; // mm cinsinden.
        }

        function calculateRealisticStacking(W_m, H_m, OD_m) {
            // Pratik Kare Yerleşim Hesabı (Metre cinsinden)
            if (OD_m <= 0) return 0;
            
            const countW = Math.floor(W_m / OD_m);
            const countH = Math.floor(H_m / OD_m);
            
            return countW * countH;
        }

        // REVİZYON 6.7: Fitting Yükleme Detayı (showFitLayout) fonksiyonu, hacim bilgisini kaldırıldı.
        function showFitLayout(pkg) {
            if (!pkg || !pkg.items || pkg.items.length === 0) {
                 alert(t("Hata: Yükleme detayları bulunamadı veya paket boş."));
                 return;
            }
            const lim = {
                L: parseFloat(document.getElementById('maxL').value),
                W: parseFloat(document.getElementById('maxW').value),
                H: parseFloat(document.getElementById('maxH').value),
                MaxKg: parseFloat(document.getElementById('maxWeight').value) * 1000
            };
            
            // Palet boyutlarını al (mm -> m)
            const palW = parseFloat(document.getElementById('palletW').value) / 1000;
            const palL = parseFloat(document.getElementById('palletL').value) / 1000;
            const palH = parseFloat(document.getElementById('palletH').value) / 1000;

            // 1. Öğeleri benzersiz tip/boyut ve paketlemeye göre grupla
            let uniqueItems = {};
            pkg.items.forEach(i => {
                // Gruplama için benzersiz anahtar
                const key = `${i.reportDesc}|${i.pack}|${i.disp_l}|${i.disp_wid}|${i.h}|${i.w}`;
                if (!uniqueItems[key]) {
                    uniqueItems[key] = {
                        item: i,
                        qty: 0,
                        totalWeight: 0,
                        // Palet hesaplaması (birim parça için)
                        requiredPallets: (i.pack === 'Pallet') 
                                        ? Math.ceil((i.l / 1000) / palL) * Math.ceil((i.wid / 1000) / palW)
                                        : 0
                    };
                }
                uniqueItems[key].qty++;
                uniqueItems[key].totalWeight += i.w;
            });

            let report = [];
            
            report.push(`📦 ${t('fit_plan_title')} - PAKET ID: #${pkg.id}`);
            report.push(`-----------------------------------`);
            report.push(`🚛 ${t('rep_v_type')}: ${t(document.getElementById('transportType').value)}`);
            report.push(`⚖️ Toplam Ağırlık: ${(pkg.totalWeight / 1000).toFixed(2)} Ton / Max: ${(lim.MaxKg/1000).toFixed(2)} Ton`);
            // report.push(`📏 Toplam Hacim (Tahmini): ${pkg.totalVol.toFixed(2)} m³`); // Kaldırıldı
            report.push(`\n`);
            
            report.push(`**✅ PAKET İÇERİĞİ**`);
            report.push(`Parça Tanımı | Adet | Paket | Boyut (mm, L x W x H) | Birim Kg`);
            // Tablo başlığı çizgisi kaldırıldı.

            Object.values(uniqueItems).forEach(group => {
                const i = group.item;
                const itemQty = group.qty;
                const packType = t(i.pack === 'Pallet' ? 'opt_pallet' : 'opt_loose');
                
                const dimText = i.type === 'CUSTOM' 
                    ? `${i.l} x ${i.wid} x ${i.h}` 
                    : `${i.disp_l} x ${Math.round(i.disp_wid)} x ${Math.round(i.h)}`; 
                
                let row = `${i.reportDesc} | ${itemQty} | ${packType}`;
                
                if (i.pack === 'Pallet') {
                    row += ` (${group.requiredPallets} Palet/Adet)`;
                }
                
                row += ` | ${dimText} | ${i.w} kg`;
                
                report.push(row);
            });

            report.push(`\n**⚠️ ÖNEMLİ YERLEŞİM NOTLARI**`);
            report.push(`* En ağır ve büyük parçaları (örn: Tee, Büyük Dirsek) TIR zeminine yerleştirin.`);
            report.push(`* Paletli yükler (${t('opt_pallet')}), belirlenen palet boyutlarına (L:${(palL*1000).toFixed(0)}xW:${(palW*1000).toFixed(0)}mm) uygun şekilde istiflenmelidir.`);
            report.push(`* Dökme yükler (${t('opt_loose')}), boru veya paletli yüklerin arasındaki boşlukları doldurmak için kullanılmalıdır.`);
            report.push(`* Maksimum yükleme yüksekliği (${lim.H.toFixed(2)}m) aşılmamalıdır.`);
            

            // Markdown formatını düz metin/alert çıktısı için dönüştürme
            const finalReport = report.join('\n').replace(/(\*\*|`)/g, '');

            // Alert ile göster
            alert(finalReport);
        }

        function downloadReport(format){
            if(finalPackages.length===0)return alert(t("Hesaplama yapınız."));
            const proj = document.getElementById('txtProject').value || t('Tanımsız Proje');
            const user = document.getElementById('txtUser').value;
            const date = new Date().toLocaleDateString(currentLang==='tr'?'tr-TR':'en-US');
            const vTypeKey = document.getElementById('transportType').value;
            const vType = t(vTypeKey);
            const lim = TRANSPORT_DATA[vTypeKey] || TRANSPORT_DATA['tr_std'];
            
            const headerTitle = t('rep_title');
            const lblBy = t('rep_by');
            const lblDate = t('rep_date');
            const lblVType = t('rep_v_type');
            
            const css = `
                <style>
                    body { font-family: Arial, sans-serif; font-size: 10pt; color: #333; }
                    .header { margin-bottom: 20px; padding: 10px; border-bottom: 3px solid #2563eb; }
                    .header h1 { font-size: 16pt; margin: 0; color: #2563eb; }
                    .header p { font-size: 10pt; margin: 2px 0; }
                    .summary-table th { background-color: #e6f0ff; color: #2563eb; }
                    .section-title { font-size: 14pt; color: #1e293b; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin: 20px 0 10px 0; font-weight: bold; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    .truck-card { border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; page-break-inside: avoid; overflow: hidden; }
                    .truck-header { background-color: #1e293b; color: white; padding: 8px 10px; font-weight: bold; font-size: 11pt; }
                    .truck-content { padding: 10px; }
                </style>
            `;
            let body = `<div class="header">
                <h1>${headerTitle} - ${proj.toUpperCase()}</h1>
                <p><b>${lblBy}:</b> ${user} | <b>${lblDate}:</b> ${date}</p>
                <p><b>${lblVType}:</b> ${vType} (L:${lim.L}m, W:${lim.W}m, H:${lim.H}m, Max:${lim.MaxKg/1000} Ton)</p>
            </div>`;
            
            body += `<div class="section-title">${t('rep_gen_list')}</div>`;
            let allItems = [...pipeItems.map(p => ({ Desc: generateReportDesc(p), Unit: 'm', Qty: p.total })), ...fittingItems.map(f => ({ Desc: generateReportDesc(f), Unit: t('unit_adet') || 'Adet', Qty: f.qty }))];
            body += `<table class="summary-table"><thead><tr><th>${t('rep_desc')}</th><th>${t('rep_unit')}</th><th>${t('rep_qty')}</th></tr></thead><tbody>`;
            allItems.forEach(item => { body += `<tr><td>${item.Desc}</td><td>${item.Unit}</td><td>${item.Qty.toFixed(item.Unit === 'm' ? 1 : 0)}</td></tr>`; });
            body += `</tbody></table>`;

            body += `<div class="section-title">${t('rep_load_det')}</div>`;
            const groups = groupIdenticalPackages(finalPackages);
            groups.forEach(g => {
                const k = g.sample, count = g.count;
                const singleWeight = g.totalWeight / count;
                // const singleVol = g.totalVol / count; // Kaldırıldı
                
                const fW = Math.min(100, (singleWeight / lim.MaxKg) * 100).toFixed(1);
                
                const cl = k.type === 'PIPE' ? 'blue' : 'teal';

                // REVİZYON 6.7: Hacim bilgisi kaldırıldı
                let content = `<p style="font-size:10pt; margin:5px 0;"><b>${currentLang==='tr'?'Araç Başı Ağırlık':'Weight per Truck'}:</b> ${(singleWeight/1000).toFixed(2)} Ton (%${fW})</p>`;
                
                if (k.type === 'PIPE') {
                    let s = {};
                    k.items.forEach(b => {
                        const r = (p) => {
                            let ky = `DN${p.dn} PN${p.pn}`;
                            if (!s[ky]) s[ky] = 0;
                            s[ky] += p.nominalLen;
                            if (p.children) p.children.forEach(r)
                        };
                        r(b);
                    });
                    content += `<p style="font-size:10pt; margin-top:5px; border-bottom:1px solid #eee;"><b>${t('lbl_pkg_content')}</b> ${Object.entries(s).map(([k,v])=>`${k}: ${v.toFixed(1)}m`).join(' | ')}</p>`;

                    content += `<p style="font-size:10pt; font-weight:bold; margin-top:10px;">${t('rep_nesting')}</p>`;
                    let grp = {}; k.items.forEach(b => { let sig = getPipeSig(b); if (!grp[sig]) grp[sig] = { count: 0, html: getRecursiveHtml(b) }; grp[sig].count++; });
                    content += `<table><thead><tr><th>${t('rep_desc')}</th><th>${t('lbl_qty')}</th></tr></thead><tbody>`;
                    Object.values(grp).forEach(g => { content += `<tr><td>${g.html.replace(/<\/?div.*?>/g, '').replace(/margin-left:\d+px;/g, '').replace(/style="[^"]*"/g, '')}</td><td>${g.count}</td></tr>`; });
                    content += `</tbody></table>`;
                } else {
                    content += `<p style="font-size:10pt; font-weight:bold; margin-top:10px;">${t('rep_part_list')}</p>`;
                    let fGrp = {}; k.items.forEach(i => { let ky = `${i.reportDesc} ${i.pack}`; if (!fGrp[ky]) fGrp[ky] = { ...i, q: 0 }; fGrp[ky].q++ });
                    content += `<table><thead><tr><th>${t('rep_desc')}</th><th>${t('rep_size')}</th><th>${t('rep_pack')}</th><th>${t('lbl_qty')}</th></tr></thead><tbody>`;
                    Object.values(fGrp).forEach(x => { content += `<tr><td>${x.reportDesc}</td><td>${x.disp_l}x${Math.round(x.disp_wid)}</td><td>${t(x.pack==='Pallet'?'opt_pallet':'opt_loose')}</td><td>${x.q}</td></tr>`; });
                    content += `</tbody></table>`;
                    
                    // FITTING PAKETLERİ İÇİN DETAYLI İŞ EMİRİ VE ANALİZİ
                    const palL = parseFloat(document.getElementById('palletL').value) / 1000;
                    const palW = parseFloat(document.getElementById('palletW').value) / 1000;
                    const palH = parseFloat(document.getElementById('palletH').value) / 1000;
                    
                    let reportLines = [];
                    reportLines.push(`📋 YÜKLEME DETAY ÖZETİ`);
                    reportLines.push(`-----------------------------------`);
                    reportLines.push(`Parça | Adet | Paket | Boyut (L x W x H - mm) | Birim Kg`);
                    
                    Object.values(fGrp).forEach(x => {
                        const packType = t(x.pack === 'Pallet' ? 'opt_pallet' : 'opt_loose');
                        const dimText = x.type === 'CUSTOM' ? `${x.l}x${x.wid}x${x.h}` : `${x.disp_l}x${Math.round(x.disp_wid)}x${Math.round(x.h)}`; 
                        let palletNote = '';
                        if (x.pack === 'Pallet') {
                            const reqPallets = Math.ceil((x.l / 1000) / palL) * Math.ceil((x.wid / 1000) / palW);
                            palletNote = ` (${reqPallets} Palet/Adet)`;
                        }
                        reportLines.push(`${x.reportDesc} | ${x.q} | ${packType}${palletNote} | ${dimText} | ${x.w} kg`);
                    });
                    reportLines.push(`\n⚠️ ÖNEMLİ NOTLAR`);
                    reportLines.push(`* Ağır parçalar daima zemine yakın olmalı.`);
                    reportLines.push(`* Dökme yükler boşluk doldurucu olarak kullanılmalıdır.`);

                    content += `<p style="font-size:10pt; font-weight:bold; margin-top:10px;">${t('rep_work_order')}</p>`;
                    content += `<pre style="white-space: pre-wrap; font-size: 9pt; background: #fafafa; border: 1px solid #eee; padding: 5px; border-radius: 3px;">${reportLines.join('\n').replace(/(\*\*|`)/g, '')}</pre>`;
                }
                body += `<div class="truck-card"><div class="truck-header" style="background-color: ${cl==='blue'?'#2563eb':'#059669'};">${vType} ${g.labelID} (${g.type}) ${count > 1 ? `x${count}` : ''}</div><div class="truck-content">${content}</div></div>`;
            });

            let fullHtml = `<html><head><meta charset='utf-8'>${css}</head><body>${body}</body></html>`;
            if (format === 'word') {
                const b=new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(b);
                link.download = `GPACK_Report_${proj.replace(/\s/g, '_')}.doc`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } else if (format === 'pdf') { 
                const printWindow = window.open('', '_blank');
                printWindow.document.write(fullHtml); 
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 500); 
            }
        }
        
        function calculateAll(){
            if(pipeItems.length === 0 && fittingItems.length === 0) return alert(t("Lütfen boru veya fitting ekleyin."));
            finalPackages=[];
            
            let maxKgInput = parseFloat(document.getElementById('maxWeight').value);
            let maxKgForCalc = maxKgInput * 1000; 

            const lim={
                L:parseFloat(document.getElementById('maxL').value),
                W:parseFloat(document.getElementById('maxW').value),
                H:parseFloat(document.getElementById('maxH').value), 
                MaxKg: maxKgForCalc
            };
            
            // Boru listesini güncelle (yeni parametreler için efektif boy hesabı)
            pipeItems.forEach(item => reCalculatePipeItem(item));

            // --- BÖLÜM 1: BORU NESTING ---
            let rP=[]; 
            pipeItems.forEach(r=>{
                let rd=REAL_ODS[r.dn]||r.dn*1.05, nd=r.hasCpl?(rd+30):rd;
                const c=Math.floor(r.total/r.len), rm=r.total%r.len;
                const add=(l,effL)=>rP.push({
                    id:Math.random().toString(36).substr(2,5),
                    dn:r.dn, pn:r.pn, sn:r.sn,
                    od:nd, realOD:rd, // realOD: Dış Çap
                    len:l, effectiveLen: effL, nominalLen:l, 
                    weight:getPipeWeightPerMeter(r.dn, r.pn, r.sn) * l, // Basit ağırlık ataması
                    children:[], hasC:r.hasCpl, isFitting:false, unit: 'Adet',
                    totalBundleWeight: 0
                });
                for(let i=0;i<c;i++) add(r.len, r.effectiveLen);
                if(rm>0.5) add(rm, rm + (r.effectiveLen - r.len)); 
            });

            const pipeErrors = checkPipeLimits(rP, lim);
            const fitErrors = checkFitLimits(fittingItems, lim);
            if(pipeErrors.length > 0 || fitErrors.length > 0) {
                let msg = t('err_limits_exceeded') + "\n\nBORU Hataları:\n" + (pipeErrors.join('\n') || t('opt_empty')) + "\n\nFITTING Hataları:\n" + (fitErrors.join('\n') || t('opt_empty'));
                return alert(msg);
            }
            
            if(rP.length>0){
                rP.sort((a,b)=>b.dn-a.dn);
                let pool=[...rP]; 
                let bundles=[]; 

                const nest = (currentHost, candidatePool, rootBundle) => {
                    let spaceLeft = currentHost.nominalLen + 0.30; 
                    
                    while(spaceLeft > 0.5) {
                        let bestIdx = -1;
                        for(let i=0; i < candidatePool.length; i++){
                            let candidate = candidatePool[i];
                            
                            if(canNest(currentHost, candidate) && candidate.nominalLen <= spaceLeft) {
                                let projectedWeight = rootBundle.totalBundleWeight + candidate.weight;
                                if (projectedWeight <= lim.MaxKg) {
                                    bestIdx = i;
                                    break;
                                }
                            }
                        }

                        if(bestIdx > -1) {
                            let inn = candidatePool.splice(bestIdx, 1)[0];
                            currentHost.children.push(inn);
                            rootBundle.totalBundleWeight += inn.weight;
                            spaceLeft -= inn.nominalLen;
                            nest(inn, candidatePool, rootBundle);
                        } else {
                            break; 
                        }
                    }
                };

                while(pool.length > 0){
                    let outer = pool.shift(); 
                    outer.totalBundleWeight = outer.weight; 
                    nest(outer, pool, outer);
                    bundles.push(outer);
                }
                
                bundles.sort((a,b)=>b.dn-a.dn); 

                let pkg={id:1, type:'PIPE', items:[], totalWeight:0, identifier:null, totalVol: 0};
                
                bundles.forEach(b=>{
                    let req=false;
                    let ref = pkg.items.length>0 ? pkg.items[0] : b;
                    
                    const pipeOD_m = ref.realOD / 1000;
                    const pipesPerCrossSection = calculateRealisticStacking(lim.W, lim.H, pipeOD_m); 
                    const pipesLengthWise = Math.floor(lim.L / ref.effectiveLen);
                    const cap = pipesPerCrossSection * pipesLengthWise;

                    if(pkg.items.length > 0){ 
                        const weightExceeded = (pkg.totalWeight + b.totalBundleWeight) > lim.MaxKg;
                        const capExceeded = (pkg.items.length + 1) > cap;
                        
                        if(weightExceeded || capExceeded) req = true; 
                    }
                    
                    if(req){ 
                        finalPackages.push(pkg); 
                        pkg={id:finalPackages.length+1, type:'PIPE', items:[], totalWeight:0, identifier:b.od, totalVol: 0}; 
                    }
                    
                    if(pkg.items.length===0) pkg.identifier=b.od; 
                    pkg.items.push(b);
                    pkg.totalWeight += b.totalBundleWeight; 
                    pkg.totalVol += Math.PI * (b.realOD/1000/2)**2 * b.effectiveLen; 
                });
                if(pkg.items.length>0) finalPackages.push(pkg);
            }

            // --- BÖLÜM 2: FITTING HESAPLAMA (KONSOLİDASYON - REALİSTİK LİMİT EKLENDİ) ---
            if(fittingItems.length>0){
                let p=[];
                fittingItems.forEach(i=>{for(let k=0;k<i.qty;k++)p.push({...i})}); 
                p.sort((a,b)=>b.vol-a.vol); // En hacimli olandan başla (Greedy)
                
                let sid=finalPackages.length+1, tr=[];
                let lp=0; 
                
                // Palet boyutları (metre)
                const palL = parseFloat(document.getElementById('palletL').value) / 1000;
                const palW = parseFloat(document.getElementById('palletW').value) / 1000;
                const palH = parseFloat(document.getElementById('palletH').value) / 1000;
                const maxVolume = lim.L * lim.W * lim.H * 0.90; // %90 hacim kullanım kuralı

                while(p.length>0){
                    if(lp++>5000) { alert(`${t("Döngü hatası: Fitting hesaplanamıyor.")}`); break; }
                    
                    let t={id:sid+tr.length, type:'FITTING', items:[], totalWeight:0, totalVol: 0, totalFootprint: 0, maxQty: Infinity}; 
                    let rem=[], add=0;
                    
                    let firstItem = p[0];
                    
                    // YENİ: GEOMETRİK LİMİT HESAPLAMASI (t.maxQty)
                    let maxTheoreticalQty = Infinity;
                    let pl_max=firstItem.l/1000, pw_max=firstItem.wid/1000, ph_max=firstItem.h/1000;
                    
                    if(pl_max > 0 && pw_max > 0 && ph_max > 0){
                        // Paletli veya Dökme olmasına göre efektif yüksekliği belirle
                        let effectiveH_for_calc = (firstItem.pack === 'Pallet') ? ph_max + palH : ph_max;
                        
                        let permutations = [
                            [pl_max, pw_max, effectiveH_for_calc], [pl_max, effectiveH_for_calc, pw_max], 
                            [pw_max, pl_max, effectiveH_for_calc], [pw_max, effectiveH_for_calc, pl_max], 
                            [effectiveH_for_calc, pl_max, pw_max], [effectiveH_for_calc, pw_max, pl_max]  
                        ];
                        
                        maxTheoreticalQty = 0;
                        permutations.forEach(([l_i, w_i, h_i]) => {
                            let l_qty = Math.floor(lim.L / l_i); 
                            let w_qty = Math.floor(lim.W / w_i); 
                            let h_qty = Math.floor(lim.H / h_i); 
                            let currentQty = l_qty * w_qty * h_qty;
                            if(currentQty > maxTheoreticalQty) maxTheoreticalQty = currentQty;
                        });
                        
                        // Paletli ürünler için maxTheoreticalQty'yi 0.90 ile çarpmıyoruz.
                        // Loose ürünler için de buraya hard-coding yapılmıyor, çünkü maxTheoreticalQty 
                        // zaten kare istifleme ile en kötü durum fiziksel limitini temsil ediyor.
                        // Bu limit, 123 olan hacimsel limit yerine kullanılacaktır.

                        t.maxQty = maxTheoreticalQty; // Pakete girecek maksimum adet kısıtlaması
                    }
                    
                    p.forEach(x=>{
                        let pl_item=x.l/1000, pw_item=x.wid/1000, ph_item=x.h/1000, fits=false;
                        let additionalPalletVolume = 0; 
                        let itemFootprint = pl_item * pw_item; 

                        if (x.pack === 'Pallet') {
                            let effectiveH = ph_item + palH; 
                            
                            // TIR'a sığma kontrolü
                            fits = (pl_item <= lim.L && pw_item <= lim.W && effectiveH <= lim.H) ||
                                   (pl_item <= lim.L && pw_item <= lim.H && effectiveH <= lim.W) ||
                                   (pw_item <= lim.L && pl_item <= lim.W && effectiveH <= lim.H) ||
                                   (pw_item <= lim.L && pl_item <= lim.H && effectiveH <= lim.W) ||
                                   (effectiveH <= lim.L && pl_item <= lim.W && pw_item <= lim.H) ||
                                   (effectiveH <= lim.L && pw_item <= lim.W && pl_item <= lim.H); 
                                   
                            // Palet sayısı hesaplama
                            const numPalletsL = Math.ceil(pl_item / palL);
                            const numPalletsW = Math.ceil(pw_item / palW);
                            const totalPallets = numPalletsL * numPalletsW;
                            
                            // Hacme eklenecek palet hacmi
                            additionalPalletVolume = totalPallets * palL * palW * palH;
                            
                            // Paletli ürün için taban alanı: kullanılan paletlerin alanı
                            itemFootprint = totalPallets * palL * palW;
                            
                        } else { 
                            // Dökme kontrolü aynı kalır
                            fits = (pl_item <= lim.L && pw_item <= lim.W && ph_item <= lim.H) ||
                                   (pl_item <= lim.L && pw_item <= lim.H && ph_item <= lim.W) ||
                                   (pw_item <= lim.L && pl_item <= lim.W && ph_item <= lim.H) ||
                                   (pw_item <= lim.L && pl_item <= lim.H && ph_item <= lim.W) ||
                                   (ph_item <= lim.L && pl_item <= lim.W && pw_item <= lim.H) ||
                                   (ph_item <= lim.L && pw_item <= lim.W && pl_item <= lim.H); 
                        }

                        // KONSOLİDASYON KONTROLÜ (Ağırlık, Hacim ve GEOMETRİK ADET kısıtlamaları)
                        if(fits && (t.totalWeight+x.w<=lim.MaxKg) && (t.totalVol + x.vol + additionalPalletVolume <= maxVolume) && (t.items.length + 1 <= t.maxQty)){
                            t.items.push(x);
                            t.totalWeight+=x.w;
                            t.totalVol+=x.vol + additionalPalletVolume;
                            t.totalFootprint += itemFootprint; 
                            add++;
                        } else {
                            rem.push(x);
                        }
                    });
                    
                    if(add===0 && rem.length>0){
                        if (t.items.length === 0) { 
                           alert(`${t("Fitting")} "${rem[0].desc}" ${t("araca sığmıyor.")} (Kg: ${rem[0].w} | Boyutlar limit dışı)`);
                           return;
                        }
                    } 
                    
                    tr.push(t);
                    p=rem;
                }
                finalPackages.push(...tr);
            }
            // Boru ve fitting hesaplamaları bittikten sonra sonucu göster.
            renderFinalPlan(lim);
        }
    </script>
</body>
</html>


